# Orange Car Rental - Aspire Quick Start Guide

Complete guide for running the Orange Car Rental microservices application using .NET Aspire.

## Overview

This application uses .NET Aspire for local development orchestration, providing:
- Automatic service discovery and configuration
- Built-in observability (logs, traces, metrics)
- Container lifecycle management
- SQL Server database provisioning
- Keycloak authentication

## Prerequisites

- .NET 10 SDK
- Docker Desktop
- Node.js 18+ (for frontend)
- .NET Aspire Workload:
  ```bash
  dotnet workload install aspire
  ```

## Quick Start

### 1. Start the Application Stack

```bash
cd src/backend/AppHost/OrangeCarRental.AppHost
dotnet run
```

This single command starts:
- SQL Server container with 4 databases
- Keycloak authentication server
- 4 backend microservices (Customers, Fleet, Reservations, Pricing)
- API Gateway (YARP reverse proxy)
- Frontend applications (Public Portal, Call Center Portal)

### 2. Access the Aspire Dashboard

The dashboard URL will be displayed in the console output:
```
https://localhost:17161/login?t={token}
```

The Aspire Dashboard provides:
- Real-time service status and health
- Structured logs from all services
- Distributed tracing
- Metrics and performance data
- Environment variables and configuration

### 3. Access the Applications

| Application | URL | Description |
|-------------|-----|-------------|
| Aspire Dashboard | https://localhost:17161 | Service orchestration and monitoring |
| Shell | http://localhost:4300 | Microfrontend host application |
| Public Portal | http://localhost:4301 | Customer-facing booking interface |
| Call Center Portal | http://localhost:4302 | Agent reservation management |
| API Gateway | http://localhost:5002 | REST API endpoint |
| Keycloak | http://localhost:8080 | Authentication server |

## Database Information

### SQL Server Databases

The application uses 4 separate databases (database-per-service pattern):

1. **OrangeCarRental_Customers** - Customer profiles and driver licenses
2. **OrangeCarRental_Fleet** - Vehicle inventory and availability
3. **OrangeCarRental_Reservations** - Booking and rental history
4. **OrangeCarRental_Pricing** - Pricing policies and rate calculations

### Connection Details

Aspire automatically configures connection strings. To connect manually:
- **Host**: localhost
- **Port**: 1433 (dynamically assigned by Aspire)
- **User**: SA
- **Password**: Auto-generated by Aspire

Connection strings are visible in the Aspire Dashboard under each service's environment variables.

### Seed Data

On first startup, services automatically seed test data:

**Customers** (5 test customers):
- German customers with realistic addresses
- Valid driver's license information
- Different salutations and statuses

**Fleet** (33+ vehicles):
- Multiple categories (Compact, SUV, Midsize, Luxury, etc.)
- Various fuel types (Petrol, Diesel, Electric, Hybrid)
- Different transmission types (Manual, Automatic)
- Spread across major German cities

**Locations** (5 rental locations):
- Berlin, München, Hamburg, Köln, Frankfurt
- Opening hours and contact information

**Reservations** (8 test bookings):
- 2 Confirmed (upcoming)
- 1 Active (currently rented)
- 1 Pending (awaiting payment)
- 3 Completed (past rentals)
- 1 Cancelled

## API Testing

### Health Check

```bash
curl http://localhost:5002/health
```

Expected response:
```json
{
  "service": "API Gateway",
  "status": "Healthy",
  "timestamp": "2025-11-22T21:39:18.1765081Z"
}
```

### Get Available Vehicles

```bash
curl http://localhost:5002/api/vehicles
```

Returns paginated list of vehicles with:
- Vehicle details (make, model, category)
- Pricing information (net, VAT, gross)
- Availability status
- Location information

### Get Customer Information

```bash
curl http://localhost:5002/api/customers/{customerId}
```

Note: Most customer endpoints require JWT authentication via Keycloak.

## Observability

### Aspire Dashboard Features

**Structured Logs**:
- Filter by service, log level, timestamp
- Search across all services simultaneously
- Serilog integration with contextual properties

**Distributed Tracing**:
- End-to-end request tracing
- Service-to-service communication visualization
- Performance bottleneck identification

**Metrics**:
- HTTP request rates and durations
- Database connection pool usage
- Custom application metrics

**Resources**:
- Container status and health
- Database connection status
- Service dependencies

## Development Workflow

### Making Code Changes

1. Stop the Aspire AppHost (Ctrl+C)
2. Make your code changes
3. Restart the AppHost:
   ```bash
   dotnet run
   ```

Aspire will:
- Rebuild changed projects
- Restart affected services
- Maintain database state (persistent volumes)

### Running Migrations

Aspire includes a database migrator service that runs automatically on startup. To run migrations manually:

```bash
cd src/backend/AppHost/OrangeCarRental.AppHost
dotnet run
```

Then trigger the `db-migrator` service from the Aspire Dashboard.

### Debugging

Set breakpoints in your IDE and attach to the running processes shown in the Aspire Dashboard.

For Visual Studio:
1. Debug > Attach to Process
2. Find the service process (e.g., `OrangeCarRental.Fleet.Api.exe`)
3. Attach debugger

## Troubleshooting

### Port Already in Use

If you see errors about ports already in use:

```bash
# Check which process is using the port
netstat -ano | findstr :5002

# Kill the process (Windows)
taskkill /PID {process_id} /F
```

### Database Connection Errors

1. Check SQL Server container status in Aspire Dashboard
2. Verify connection string in service environment variables
3. Check service logs for detailed error messages

### Service Won't Start

1. Check the Aspire Dashboard for service status
2. Review service logs for startup errors
3. Ensure all dependencies are running (SQL Server, Keycloak)
4. Verify Docker Desktop is running

### Frontend Not Loading

1. Check if port 4200/4201 is available
2. Verify Node.js is installed (`node --version`)
3. Check NPM package installation completed
4. Review frontend logs in Aspire Dashboard

## Architecture

### Service Communication

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │
       v
┌─────────────────┐
│  API Gateway    │ (Port 5002)
│     (YARP)      │
└────────┬────────┘
         │
    ┌────┴────┬─────────┬─────────┐
    v         v         v         v
┌────────┐┌────────┐┌────────┐┌────────┐
│Fleet   ││Reserv. ││Pricing ││Customer│
│Service ││Service ││Service ││Service │
└───┬────┘└───┬────┘└───┬────┘└───┬────┘
    │         │         │         │
    └─────────┴─────────┴─────────┘
                   │
                   v
           ┌──────────────┐
           │  SQL Server  │
           │  (4 DBs)     │
           └──────────────┘
```

### Database Per Service

Each microservice has its own database for:
- Data isolation
- Independent scaling
- Technology flexibility
- Fault isolation

## Production Considerations

**Important**: Aspire is designed for local development. For production:

1. Use proper container orchestration (Kubernetes, Docker Swarm)
2. Configure production-grade SQL Server or Azure SQL
3. Set up proper authentication and authorization
4. Implement API rate limiting and throttling
5. Configure monitoring and alerting
6. Use secrets management (Azure Key Vault, etc.)
7. Enable SSL/TLS for all communications
8. Implement proper backup and disaster recovery

## Additional Resources

- [.NET Aspire Documentation](https://learn.microsoft.com/en-us/dotnet/aspire/)
- Database migrations run automatically via the `db-migrator` service
- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [YARP Documentation](https://microsoft.github.io/reverse-proxy/)

## Support

For issues or questions:
1. Check Aspire Dashboard logs
2. Review service-specific logs in `Aspire Dashboard > Logs`
3. Verify all containers are healthy
4. Check database connectivity

## Summary

The Orange Car Rental application demonstrates:
- Microservices architecture with .NET 10
- Database-per-service pattern
- API Gateway pattern with YARP
- JWT authentication with Keycloak
- .NET Aspire for local orchestration
- Clean Architecture principles
- Domain-Driven Design patterns

Start developing with a single command: `dotnet run`
