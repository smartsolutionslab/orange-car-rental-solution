name: Lighthouse CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  lighthouse:
    name: Run Lighthouse Performance Tests
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: TestPassword123!
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword123! -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'yarn'
          cache-dependency-path: src/frontend/yarn.lock

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Install dependencies
        working-directory: src/frontend
        run: yarn install --frozen-lockfile

      - name: Build Public Portal
        working-directory: src/frontend
        run: yarn workspace @orange-car-rental/public-portal build:production

      - name: Build Call Center Portal
        working-directory: src/frontend
        run: yarn workspace @orange-car-rental/call-center-portal build:production

      - name: Start Backend API
        run: |
          cd src/backend/ApiGateway/OrangeCarRental.ApiGateway
          dotnet restore
          dotnet build
          dotnet run &
          sleep 30
        env:
          ASPNETCORE_ENVIRONMENT: Development
          ConnectionStrings__DefaultConnection: Server=localhost;Database=orange_rental;User Id=sa;Password=TestPassword123!;TrustServerCertificate=True
        continue-on-error: true

      - name: Serve Public Portal
        run: |
          npx http-server src/frontend/apps/public-portal/dist/public-portal/browser -p 4301 &
          sleep 10

      - name: Serve Call Center Portal
        run: |
          npx http-server src/frontend/apps/call-center-portal/dist/call-center-portal/browser -p 4302 &
          sleep 10

      - name: Run Lighthouse CI - Public Portal
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      - name: Run Lighthouse CI - Call Center Portal
        run: |
          lhci autorun --config=lighthouserc-callcenter.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lighthouse-*.html
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            try {
              const results = JSON.parse(fs.readFileSync('.lighthouseci/manifest.json', 'utf8'));
              let comment = '## Lighthouse Performance Report\n\n';
              comment += 'Detailed reports available in artifacts';
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (e) {
              console.log('Lighthouse results not available');
            }

  performance-budget:
    name: Check Performance Budget
    runs-on: ubuntu-latest
    needs: lighthouse
    if: needs.lighthouse.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Lighthouse Reports
        uses: actions/download-artifact@v7
        with:
          name: lighthouse-reports
        continue-on-error: true

      - name: Check Performance Budget
        run: |
          if [ -d ".lighthouseci" ]; then
            echo "Checking performance metrics against budget..."
            # Add actual budget checks here when needed
            echo "Performance budget check completed"
          else
            echo "No Lighthouse reports found - skipping budget check"
          fi
