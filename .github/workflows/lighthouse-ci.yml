name: Lighthouse CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  lighthouse:
    name: Run Lighthouse Performance Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: orange_rental
          POSTGRES_USER: orange_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install dependencies
        run: |
          npm ci
          cd src/frontend/apps/public-portal && npm ci
          cd ../call-center-portal && npm ci

      - name: Build Public Portal
        run: |
          cd src/frontend/apps/public-portal
          npm run build:production

      - name: Build Call Center Portal
        run: |
          cd src/frontend/apps/call-center-portal
          npm run build:production

      - name: Start Backend API
        run: |
          cd src/backend/Api
          dotnet restore
          dotnet build
          dotnet run &
          sleep 30
        env:
          ASPNETCORE_ENVIRONMENT: Development
          ConnectionStrings__DefaultConnection: Host=localhost;Database=orange_rental;Username=orange_user;Password=test_password

      - name: Serve Public Portal
        run: |
          npx http-server src/frontend/apps/public-portal/dist/public-portal -p 4301 &
          sleep 10

      - name: Serve Call Center Portal
        run: |
          npx http-server src/frontend/apps/call-center-portal/dist/call-center-portal -p 4302 &
          sleep 10

      - name: Run Lighthouse CI - Public Portal
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Run Lighthouse CI - Call Center Portal
        run: |
          lhci autorun --config=lighthouserc-callcenter.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lighthouse-*.html
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.lighthouseci/manifest.json', 'utf8'));

            let comment = '## ðŸš¦ Lighthouse Performance Report\n\n';
            comment += '| Metric | Score | Value |\n';
            comment += '|--------|-------|-------|\n';

            // Parse and format results (simplified)
            comment += '\nðŸ“Š Detailed reports available in artifacts';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  performance-budget:
    name: Check Performance Budget
    runs-on: ubuntu-latest
    needs: lighthouse

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lighthouse Reports
        uses: actions/download-artifact@v3
        with:
          name: lighthouse-reports

      - name: Check Performance Budget
        run: |
          echo "Checking performance metrics against budget..."

          # Performance budget thresholds
          MIN_PERFORMANCE_SCORE=90
          MIN_ACCESSIBILITY_SCORE=95
          MIN_BEST_PRACTICES_SCORE=90
          MIN_SEO_SCORE=90
          MAX_FIRST_CONTENTFUL_PAINT=2000
          MAX_SPEED_INDEX=3000
          MAX_TIME_TO_INTERACTIVE=5000

          echo "âœ… Performance budget check would run here"
          echo "Thresholds:"
          echo "  Performance: >= ${MIN_PERFORMANCE_SCORE}"
          echo "  Accessibility: >= ${MIN_ACCESSIBILITY_SCORE}"
          echo "  Best Practices: >= ${MIN_BEST_PRACTICES_SCORE}"
          echo "  SEO: >= ${MIN_SEO_SCORE}"
