name: Deploy

on:
  workflow_run:
    workflows: ["Backend CI", "Frontend CI"]
    types:
      - completed
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  packages: write

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
    - name: Check workflow run status
      id: check
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        fi

    - name: Determine environment
      id: set-env
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.workflow_run.head_branch }}" == "develop" ]]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
        else
          echo "environment=none" >> $GITHUB_OUTPUT
        fi

  deploy-backend:
    needs: determine-environment
    if: needs.determine-environment.outputs.should-deploy == 'true' && needs.determine-environment.outputs.environment != 'none'
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set image tag
      id: set-tag
      run: |
        if [[ "${{ needs.determine-environment.outputs.environment }}" == "production" ]]; then
          echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=latest" >> $GITHUB_OUTPUT
        fi

    - name: Verify images available
      run: |
        echo "Verifying container images are available in GHCR..."
        docker pull ghcr.io/${{ github.repository }}/api-gateway:${{ steps.set-tag.outputs.tag }} || echo "api-gateway image not found"
        echo "Images verified. Ready for deployment via .NET Aspire."

    - name: Deployment summary
      run: |
        echo "## Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ steps.set-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Services**:" >> $GITHUB_STEP_SUMMARY
        echo "  - Fleet API" >> $GITHUB_STEP_SUMMARY
        echo "  - Reservations API" >> $GITHUB_STEP_SUMMARY
        echo "  - Customers API" >> $GITHUB_STEP_SUMMARY
        echo "  - Pricing API" >> $GITHUB_STEP_SUMMARY
        echo "  - Payments API" >> $GITHUB_STEP_SUMMARY
        echo "  - Notifications API" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    needs: determine-environment
    if: needs.determine-environment.outputs.should-deploy == 'true' && needs.determine-environment.outputs.environment != 'none'
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}

    strategy:
      matrix:
        app: [public-portal, call-center-portal]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set image tag
      id: set-tag
      run: |
        if [[ "${{ needs.determine-environment.outputs.environment }}" == "production" ]]; then
          echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=latest" >> $GITHUB_OUTPUT
        fi

    - name: Verify image available
      run: |
        docker pull ghcr.io/${{ github.repository }}/${{ matrix.app }}:${{ steps.set-tag.outputs.tag }} || echo "${{ matrix.app }} image not found"
        echo "Image verified. Ready for deployment via .NET Aspire."

    - name: Deployment summary
      run: |
        echo "## Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **App**: ${{ matrix.app }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ steps.set-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    needs: [determine-environment, deploy-backend, deploy-frontend]
    if: always() && needs.determine-environment.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Send deployment notification
      run: |
        if [[ "${{ needs.deploy-backend.result }}" == "success" ]] && [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
          echo "✅ Deployment to ${{ needs.determine-environment.outputs.environment }} completed successfully"
        else
          echo "❌ Deployment to ${{ needs.determine-environment.outputs.environment }} failed"
          exit 1
        fi

    # Optional: Send Slack/Teams/Email notification
    # - name: Send Slack notification
    #   uses: slackapi/slack-github-action@v1.24.0
    #   with:
    #     payload: |
    #       {
    #         "text": "Deployment to ${{ needs.determine-environment.outputs.environment }} completed",
    #         "blocks": [
    #           {
    #             "type": "section",
    #             "text": {
    #               "type": "mrkdwn",
    #               "text": "Deployment Status: ${{ needs.deploy-backend.result }}"
    #             }
    #           }
    #         ]
    #       }
    #   env:
    #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
