name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/backend/**'
      - '.github/workflows/backend-ci.yml'
      - '.github/workflows/_integration-tests.yml'
      - '.github/actions/setup-backend/**'
      - '.github/actions/setup-aspire/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/backend/**'
      - '.github/workflows/backend-ci.yml'
      - '.github/workflows/_integration-tests.yml'
      - '.github/actions/setup-backend/**'
      - '.github/actions/setup-aspire/**'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # ============================================================================
  # Version Job - Calculate semantic version using GitVersion
  # ============================================================================
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
      fullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}
      majorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}
      preReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}
      preReleaseLabel: ${{ steps.gitversion.outputs.preReleaseLabel }}
      buildMetaData: ${{ steps.gitversion.outputs.buildMetaData }}
      informationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}
      assemblySemVer: ${{ steps.gitversion.outputs.assemblySemVer }}
      assemblySemFileVer: ${{ steps.gitversion.outputs.assemblySemFileVer }}
      nuGetVersionV2: ${{ steps.gitversion.outputs.nuGetVersionV2 }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history needed for GitVersion

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.2.1
      with:
        versionSpec: '6.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v3.2.1
      with:
        useConfigFile: true
        configFilePath: GitVersion.yml

    - name: Display Version
      run: |
        echo "## Version Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| SemVer | ${{ steps.gitversion.outputs.semVer }} |" >> $GITHUB_STEP_SUMMARY
        echo "| FullSemVer | ${{ steps.gitversion.outputs.fullSemVer }} |" >> $GITHUB_STEP_SUMMARY
        echo "| NuGetVersionV2 | ${{ steps.gitversion.outputs.nuGetVersionV2 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| PreReleaseTag | ${{ steps.gitversion.outputs.preReleaseTag }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build Job - runs after version, uploads artifacts for downstream jobs
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: version
    outputs:
      artifact-name: ${{ steps.upload.outputs.artifact-id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Backend
      uses: ./.github/actions/setup-backend

    - name: Build solution
      working-directory: src/backend
      env:
        GITVERSION_SEMVER: ${{ needs.version.outputs.semVer }}
        GITVERSION_ASSEMBLYSEMVER: ${{ needs.version.outputs.assemblySemVer }}
        GITVERSION_ASSEMBLYSEMFILEVER: ${{ needs.version.outputs.assemblySemFileVer }}
        GITVERSION_INFORMATIONALVERSION: ${{ needs.version.outputs.informationalVersion }}
      run: dotnet build OrangeCarRental.sln --no-restore --configuration Release -p:RunAnalyzers=false

    - name: Upload build artifacts
      id: upload
      uses: actions/upload-artifact@v6
      with:
        name: build-output
        path: |
          src/backend/**/bin/Release/
          src/backend/**/obj/Release/
        retention-days: 1

  # ============================================================================
  # Unit Tests - runs in parallel with integration tests after build
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Backend
      uses: ./.github/actions/setup-backend

    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: build-output
        path: src/backend

    - name: Run unit tests
      working-directory: src/backend
      run: |
        dotnet test OrangeCarRental.sln \
          --no-build \
          --configuration Release \
          --filter "Category!=Integration" \
          --logger "trx;LogFileName=unit-tests.trx" \
          --collect:"XPlat Code Coverage"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: unit-test-results
        path: '**/TestResults/**/*.trx'

    - name: Upload coverage to Codecov
      if: success()
      uses: codecov/codecov-action@v5
      with:
        files: '**/coverage.cobertura.xml'
        flags: backend-unit
        name: backend-unit-coverage

  # ============================================================================
  # Integration Tests - run sequentially to avoid database race conditions
  # Each test suite runs on its own runner with isolated containers
  # ============================================================================
  integration-infrastructure:
    name: Integration (Infrastructure)
    needs: build
    uses: ./.github/workflows/_integration-tests.yml
    with:
      portal: Infrastructure
      timeout-minutes: 10
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-public:
    name: Integration (Public Portal)
    needs: [build, integration-infrastructure]  # Run after infrastructure tests
    uses: ./.github/workflows/_integration-tests.yml
    with:
      portal: Public
      timeout-minutes: 15
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-callcenter:
    name: Integration (CallCenter Portal)
    needs: [build, integration-public]  # Run after public tests
    uses: ./.github/workflows/_integration-tests.yml
    with:
      portal: CallCenter
      timeout-minutes: 15
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Docker Build - runs after all tests pass (push only)
  # ============================================================================
  docker-build:
    name: Docker Build (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [version, unit-tests, integration-infrastructure, integration-public, integration-callcenter]
    if: github.event_name == 'push'

    strategy:
      fail-fast: false
      matrix:
        include:
          - service: fleet-api
            dockerfile: Services/Fleet/OrangeCarRental.Fleet.Api/Dockerfile
          - service: reservations-api
            dockerfile: Services/Reservations/OrangeCarRental.Reservations.Api/Dockerfile
          - service: customers-api
            dockerfile: Services/Customers/OrangeCarRental.Customers.Api/Dockerfile
          - service: pricing-api
            dockerfile: Services/Pricing/OrangeCarRental.Pricing.Api/Dockerfile
          - service: payments-api
            dockerfile: Services/Payments/OrangeCarRental.Payments.Api/Dockerfile
          - service: notifications-api
            dockerfile: Services/Notifications/OrangeCarRental.Notifications.Api/Dockerfile

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/${{ matrix.service }}
        tags: |
          # Semantic version (e.g., 1.0.0, 1.0.0-dev.5)
          type=raw,value=${{ needs.version.outputs.semVer }}
          # Full semantic version with build metadata
          type=raw,value=${{ needs.version.outputs.fullSemVer }}
          # Major.Minor.Patch only (e.g., 1.0.0)
          type=raw,value=${{ needs.version.outputs.majorMinorPatch }},enable=${{ github.ref == 'refs/heads/main' }}
          # latest tag only on main branch
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          # Branch name for non-main branches
          type=ref,event=branch,enable=${{ github.ref != 'refs/heads/main' }}
          # Short SHA for traceability
          type=sha,prefix=,format=short

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./src/backend
        file: ./src/backend/${{ matrix.dockerfile }}
        push: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ needs.version.outputs.semVer }}
          INFORMATIONAL_VERSION=${{ needs.version.outputs.informationalVersion }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ============================================================================
  # Summary - report overall status
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-infrastructure, integration-public, integration-callcenter]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Backend CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration (Infrastructure) | ${{ needs.integration-infrastructure.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration (Public) | ${{ needs.integration-public.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration (CallCenter) | ${{ needs.integration-callcenter.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-infrastructure.result }}" != "success" ]] || \
             [[ "${{ needs.integration-public.result }}" != "success" ]] || \
             [[ "${{ needs.integration-callcenter.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          fi