name: CI (Using Templates)

# This workflow demonstrates using orange-ci-templates
# To switch to this workflow, rename it to build.yml and delete the old one

on:
  workflow_dispatch:  # Manual trigger only for now
  # Uncomment below to enable on push/PR
  # push:
  #   branches: [develop, main, master]
  # pull_request:
  #   branches: [develop, main, master]

jobs:
  # ============================================
  # Frontend Lint Jobs (using reusable workflow)
  # ============================================
  lint-shell:
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-lint.yml@main
    with:
      app-name: shell
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      fail-on-error: false

  lint-public-portal:
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-lint.yml@main
    with:
      app-name: public-portal
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      fail-on-error: false

  lint-call-center-portal:
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-lint.yml@main
    with:
      app-name: call-center-portal
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      fail-on-error: false

  # ============================================
  # Backend Lint Job (using reusable workflow)
  # ============================================
  lint-backend:
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/dotnet-lint.yml@main
    with:
      working-directory: src/backend
      solution-file: OrangeCarRental.sln
      exclude-diagnostics: IDE1006
      fail-on-error: false

  # ============================================
  # Frontend Build Jobs (using reusable workflow)
  # ============================================
  build-shell:
    needs: lint-shell
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-build.yml@main
    with:
      app-name: shell
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      environment: production

  build-public-portal:
    needs: lint-public-portal
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-build.yml@main
    with:
      app-name: public-portal
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      environment: production

  build-call-center-portal:
    needs: lint-call-center-portal
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/angular-build.yml@main
    with:
      app-name: call-center-portal
      working-directory: src/frontend
      package-scope: '@orange-car-rental'
      environment: production

  # ============================================
  # Backend Build Job (using reusable workflow)
  # ============================================
  build-backend:
    needs: lint-backend
    uses: smartsolutionslab/orange-ci-templates/.github/workflows/dotnet-build.yml@main
    with:
      working-directory: src/backend
      solution-file: OrangeCarRental.sln
      configuration: Release
      publish: true
      publish-project: ApiGateway/OrangeCarRental.ApiGateway

  # ============================================
  # Docker Build Jobs
  # Note: These remain inline because they need to
  # download artifacts from the build jobs above
  # ============================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-shell, build-public-portal, build-call-center-portal, build-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./src/backend
          file: ./src/backend/ApiGateway/Dockerfile
          push: false
          tags: orange-car-rental-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Download Shell artifacts
        uses: actions/download-artifact@v4
        with:
          name: shell-dist
          path: src/frontend/apps/shell/dist/

      - name: Download Public Portal artifacts
        uses: actions/download-artifact@v4
        with:
          name: public-portal-dist
          path: src/frontend/apps/public-portal/dist/

      - name: Download Call Center Portal artifacts
        uses: actions/download-artifact@v4
        with:
          name: call-center-portal-dist
          path: src/frontend/apps/call-center-portal/dist/

      - name: Build Shell Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./src/frontend/apps/shell
          file: ./src/frontend/apps/shell/Dockerfile.runtime
          push: false
          tags: orange-car-rental-shell:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Public Portal Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./src/frontend/apps/public-portal
          file: ./src/frontend/apps/public-portal/Dockerfile.runtime
          push: false
          tags: orange-car-rental-public:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Call Center Portal Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./src/frontend/apps/call-center-portal
          file: ./src/frontend/apps/call-center-portal/Dockerfile.runtime
          push: false
          tags: orange-car-rental-callcenter:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Build Summary
  # ============================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-shell, build-public-portal, build-call-center-portal, build-backend, docker-build]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Summary (Using Templates)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- Shell: ${{ needs.build-shell.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Public Portal: ${{ needs.build-public-portal.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Call Center Portal: ${{ needs.build-call-center-portal.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: ${{ needs.build-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker" >> $GITHUB_STEP_SUMMARY
          echo "- Images: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
