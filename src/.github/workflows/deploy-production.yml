name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://orange-car-rental.com
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
        export KUBECONFIG=./kubeconfig

    - name: Create Kubernetes namespace
      run: |
        kubectl create namespace orange-car-rental-prod --dry-run=client -o yaml | kubectl apply -f -

    - name: Create image pull secret
      run: |
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=${{ env.REGISTRY }} \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GITHUB_TOKEN }} \
          --namespace=orange-car-rental-prod \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy to Kubernetes
      run: |
        export IMAGE_TAG=${{ steps.version.outputs.VERSION }}

        # Apply Kubernetes manifests
        envsubst < k8s/production/deployment.yml | kubectl apply -f -
        envsubst < k8s/production/service.yml | kubectl apply -f -
        envsubst < k8s/production/ingress.yml | kubectl apply -f -

    - name: Wait for deployment
      run: |
        kubectl rollout status deployment/api-gateway -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/fleet-service -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/reservation-service -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/customer-service -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/location-service -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/call-center-portal -n orange-car-rental-prod --timeout=10m
        kubectl rollout status deployment/public-portal -n orange-car-rental-prod --timeout=10m

    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        curl -f https://orange-car-rental.com/health || exit 1
        curl -f https://orange-car-rental.com/api/locations || exit 1
        curl -f https://orange-car-rental.com/api/vehicles || exit 1

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        generate_release_notes: true
        draft: false
        prerelease: false

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Production deployment ${{ job.status }} - Version: ${{ steps.version.outputs.VERSION }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
