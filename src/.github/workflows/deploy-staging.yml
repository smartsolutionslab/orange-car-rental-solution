name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.orange-car-rental.com
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
        export KUBECONFIG=./kubeconfig

    - name: Create Kubernetes namespace
      run: |
        kubectl create namespace orange-car-rental-staging --dry-run=client -o yaml | kubectl apply -f -

    - name: Create image pull secret
      run: |
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=${{ env.REGISTRY }} \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GITHUB_TOKEN }} \
          --namespace=orange-car-rental-staging \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy to Kubernetes
      run: |
        # Update image tags to latest develop branch
        export IMAGE_TAG=develop-$(git rev-parse --short HEAD)

        # Apply Kubernetes manifests
        envsubst < k8s/staging/deployment.yml | kubectl apply -f -
        envsubst < k8s/staging/service.yml | kubectl apply -f -
        envsubst < k8s/staging/ingress.yml | kubectl apply -f -

    - name: Wait for deployment
      run: |
        kubectl rollout status deployment/api-gateway -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/fleet-service -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/reservation-service -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/customer-service -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/location-service -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/call-center-portal -n orange-car-rental-staging --timeout=5m
        kubectl rollout status deployment/public-portal -n orange-car-rental-staging --timeout=5m

    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        curl -f https://staging.orange-car-rental.com/health || exit 1
        curl -f https://staging.orange-car-rental.com/api/locations || exit 1

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Staging deployment ${{ job.status }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
