<div class="booking-history-container">
  <div class="page-header">
    <h1>Meine Buchungen</h1>
    <p class="subtitle">Verwalten Sie Ihre Reservierungen</p>
  </div>

  <!-- Authenticated User View -->
  @if (isAuthenticated()) {
    <div class="reservations-content">
      <!-- Loading State -->
      @if (isLoading()) {
        <ui-loading-state message="Buchungen werden geladen..."></ui-loading-state>
      }

      <!-- Error State -->
      @if (error()) {
        <ui-error-state
          [message]="error()!"
          [showRetry]="true"
          (retry)="loadCustomerReservations()"
        ></ui-error-state>
      }

      <!-- Reservations Content -->
      @if (!isLoading() && !error()) {
        <!-- Upcoming Bookings -->
        @if (groupedReservations().upcoming.length > 0) {
          <section class="reservations-section">
            <h2>Bevorstehende Buchungen</h2>
            <div class="reservations-grid">
              @for (reservation of groupedReservations().upcoming; track reservation.id) {
                <ui-reservation-card
                  [reservation]="reservation"
                  variant="upcoming"
                  [canCancel]="canCancel(reservation)"
                  (viewDetails)="viewDetails(reservation)"
                  (cancel)="openCancelModal(reservation)"
                ></ui-reservation-card>
              }
            </div>
          </section>
        }

        <!-- Pending Bookings -->
        @if (groupedReservations().pending.length > 0) {
          <section class="reservations-section">
            <h2>Ausstehende Bestätigungen</h2>
            <div class="reservations-grid">
              @for (reservation of groupedReservations().pending; track reservation.id) {
                <ui-reservation-card
                  [reservation]="reservation"
                  variant="pending"
                  [canCancel]="canCancel(reservation)"
                  (viewDetails)="viewDetails(reservation)"
                  (cancel)="openCancelModal(reservation)"
                ></ui-reservation-card>
              }
            </div>
          </section>
        }

        <!-- Past Bookings -->
        @if (groupedReservations().past.length > 0) {
          <section class="reservations-section">
            <h2>Vergangene Buchungen</h2>
            <div class="reservations-grid">
              @for (reservation of groupedReservations().past; track reservation.id) {
                <ui-reservation-card
                  [reservation]="reservation"
                  variant="past"
                  [showCancel]="false"
                  (viewDetails)="viewDetails(reservation)"
                ></ui-reservation-card>
              }
            </div>
          </section>
        }

        <!-- Empty State -->
        @if (
          groupedReservations().upcoming.length === 0 &&
          groupedReservations().pending.length === 0 &&
          groupedReservations().past.length === 0
        ) {
          <ui-empty-state
            icon="reservation"
            title="Keine Buchungen vorhanden"
            description="Sie haben noch keine Buchungen. Stöbern Sie in unseren Fahrzeugen und buchen Sie jetzt!"
            [showAction]="true"
            actionLabel="Fahrzeuge durchsuchen"
            (action)="navigateToVehicles()"
          ></ui-empty-state>
        }
      }
    </div>
  }

  <!-- Guest Lookup View -->
  @else {
    <div class="guest-lookup">
      <h2>Buchung suchen</h2>
      <p>Geben Sie Ihre Reservierungsnummer und E-Mail-Adresse ein, um Ihre Buchung zu finden.</p>

      <form class="lookup-form" (ngSubmit)="onGuestLookup()">
        <ui-form-field label="Reservierungsnummer" inputId="reservationId" [required]="true">
          <input
            type="text"
            id="reservationId"
            name="reservationId"
            [(ngModel)]="guestLookupForm.reservationId"
            placeholder="z.B. 550e8400-e29b-41d4"
            required
          />
        </ui-form-field>

        <ui-form-field label="E-Mail-Adresse" inputId="email" [required]="true">
          <input
            type="email"
            id="email"
            name="email"
            [(ngModel)]="guestLookupForm.email"
            placeholder="ihre@email.de"
            required
          />
        </ui-form-field>

        @if (guestLookupError()) {
          <ui-error-alert [message]="guestLookupError()!"></ui-error-alert>
        }

        <button type="submit" class="btn-primary" [disabled]="isLoading()">
          {{ isLoading() ? 'Suche läuft...' : 'Buchung suchen' }}
        </button>
      </form>

      <!-- Guest Reservation Result -->
      @if (guestReservation()) {
        <div class="guest-result">
          <h3>Ihre Buchung</h3>
          <ui-reservation-card
            [reservation]="guestReservation()!"
            variant="guest"
            [canCancel]="canCancel(guestReservation()!)"
            [showDetails]="false"
            [showPrint]="true"
            (print)="printReservation()"
            (cancel)="openCancelModal(guestReservation()!)"
          ></ui-reservation-card>
        </div>
      }
    </div>
  }

  <!-- Detail Modal -->
  <ui-modal
    [isOpen]="showDetailModal() && !!detailReservation()"
    title="Buchungsdetails"
    size="lg"
    (close)="closeDetailModal()"
  >
    <ng-container modal-body>
      @if (detailReservation()) {
        <div class="detail-section">
          <h3>Reservierung</h3>
          <ui-detail-row
            label="Reservierungsnummer:"
            [value]="detailReservation()!.id"
          ></ui-detail-row>
          <ui-detail-row label="Status:">
            <ui-status-badge
              type="reservation"
              [status]="detailReservation()!.status"
            ></ui-status-badge>
          </ui-detail-row>
        </div>

        <div class="detail-section">
          <h3>Mietzeitraum</h3>
          <ui-detail-row
            label="Abholung:"
            [value]="
              formatDate(detailReservation()!.pickupDate) +
              ' - ' +
              detailReservation()!.pickupLocationCode
            "
          ></ui-detail-row>
          <ui-detail-row
            label="Rückgabe:"
            [value]="
              formatDate(detailReservation()!.returnDate) +
              ' - ' +
              detailReservation()!.dropoffLocationCode
            "
          ></ui-detail-row>
        </div>

        <div class="detail-section">
          <h3>Preise</h3>
          <ui-detail-row
            label="Nettobetrag:"
            [value]="formatPrice(detailReservation()!.totalPriceNet)"
          ></ui-detail-row>
          <ui-detail-row
            label="MwSt. (19%):"
            [value]="formatPrice(detailReservation()!.totalPriceVat)"
          ></ui-detail-row>
          <ui-detail-row
            label="Gesamtbetrag:"
            [value]="formatPrice(detailReservation()!.totalPriceGross)"
            [strong]="true"
            [highlight]="true"
          ></ui-detail-row>
        </div>

        <div class="detail-section">
          <h3>Stornierungsbedingungen</h3>
          <p>Kostenlose Stornierung bis 48 Stunden vor Abholung.</p>
          <p>Spätere Stornierungen können Gebühren nach sich ziehen.</p>
        </div>
      }
    </ng-container>
    <ng-container modal-footer>
      <button class="btn-secondary" (click)="printReservation()">Drucken</button>
      <button class="btn-primary" (click)="closeDetailModal()">Schließen</button>
    </ng-container>
  </ui-modal>

  <!-- Cancel Modal -->
  <ui-modal
    [isOpen]="showCancelModal() && !!selectedReservation()"
    title="Buchung stornieren"
    size="sm"
    (close)="closeCancelModal()"
  >
    <ng-container modal-body>
      @if (selectedReservation()) {
        <p>Möchten Sie diese Buchung wirklich stornieren?</p>
        <p><strong>Reservierungsnummer:</strong> {{ selectedReservation()!.id }}</p>
        <p><strong>Abholtermin:</strong> {{ formatDate(selectedReservation()!.pickupDate) }}</p>

        <div class="form-group">
          <label for="cancellationReason">Grund für Stornierung *</label>
          <select id="cancellationReason" [(ngModel)]="cancellationReason" class="form-control">
            <option value="">Bitte wählen...</option>
            @for (reason of cancellationReasons; track reason) {
              <option [value]="reason">{{ reason }}</option>
            }
          </select>
        </div>

        <div class="warning-box">
          <p><strong>Hinweis:</strong> Diese Aktion kann nicht rückgängig gemacht werden.</p>
        </div>
      }
    </ng-container>
    <ng-container modal-footer>
      <button class="btn-secondary" (click)="closeCancelModal()">Abbrechen</button>
      <button
        class="btn-danger"
        (click)="confirmCancellation()"
        [disabled]="!cancellationReason || isLoading()"
      >
        {{ isLoading() ? 'Wird storniert...' : 'Stornierung bestätigen' }}
      </button>
    </ng-container>
  </ui-modal>
</div>
