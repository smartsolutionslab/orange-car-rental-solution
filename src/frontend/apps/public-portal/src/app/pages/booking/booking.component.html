<div class="booking-container">
  <!-- Header -->
  <div class="booking-header">
    <h1>{{ 'booking.title' | translate }}</h1>
    <p class="subtitle">
      {{ 'booking.subtitle' | translate: { steps: totalSteps } }}
    </p>
  </div>

  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-steps">
      @for (step of [1, 2, 3, 4, 5]; track step) {
        <div
          class="progress-step"
          [class.active]="currentStep() >= step"
          [class.current]="currentStep() === step"
        >
          <div class="step-circle">{{ step }}</div>
          <div class="step-label">
            @switch (step) {
              @case (1) {
                {{ 'booking.steps.details' | translate }}
              }
              @case (2) {
                {{ 'booking.steps.personal' | translate }}
              }
              @case (3) {
                {{ 'booking.steps.address' | translate }}
              }
              @case (4) {
                {{ 'booking.steps.license' | translate }}
              }
              @case (5) {
                {{ 'booking.steps.review' | translate }}
              }
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <ui-error-alert [message]="error()!"></ui-error-alert>
  }

  <!-- Form -->
  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="booking-form">
    <!-- Step 1: Vehicle and Booking Details -->
    @if (currentStep() === 1) {
      <div class="form-step">
        <h2>{{ 'booking.steps.details' | translate }}</h2>
        <p class="step-description">{{ 'booking.step1.description' | translate }}</p>

        <div class="form-grid">
          <div class="form-field full-width">
            <label for="pickupDate">{{ 'booking.fields.pickupDate' | translate }} *</label>
            <input
              type="date"
              id="pickupDate"
              formControlName="pickupDate"
              [min]="today"
              [class.invalid]="
                bookingForm.get('pickupDate')?.invalid && bookingForm.get('pickupDate')?.touched
              "
            />
            @if (bookingForm.get('pickupDate')?.invalid && bookingForm.get('pickupDate')?.touched) {
              <span class="error-text">{{ 'booking.errors.pickupDate' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="returnDate">{{ 'booking.fields.returnDate' | translate }} *</label>
            <input
              type="date"
              id="returnDate"
              formControlName="returnDate"
              [min]="minReturnDate()"
              [class.invalid]="
                bookingForm.get('returnDate')?.invalid && bookingForm.get('returnDate')?.touched
              "
            />
            @if (bookingForm.get('returnDate')?.invalid && bookingForm.get('returnDate')?.touched) {
              <span class="error-text">{{ 'booking.errors.returnDate' | translate }}</span>
            }
          </div>

          @if (getRentalDays() > 0) {
            <div class="rental-info">
              <lib-icon name="clock-filled" variant="filled" size="sm" />
              <span
                >{{ getRentalDays() }}
                {{
                  (getRentalDays() === 1 ? 'common.labels.day' : 'common.labels.days') | translate
                }}</span
              >
            </div>
          }

          <div class="form-field full-width">
            <label for="pickupLocationCode"
              >{{ 'booking.fields.pickupStation' | translate }} *</label
            >
            <ui-select-location
              id="pickupLocationCode"
              formControlName="pickupLocationCode"
              [placeholder]="'common.placeholders.select' | translate"
              [showCity]="true"
              [class.invalid]="
                bookingForm.get('pickupLocationCode')?.invalid &&
                bookingForm.get('pickupLocationCode')?.touched
              "
            />
            @if (
              bookingForm.get('pickupLocationCode')?.invalid &&
              bookingForm.get('pickupLocationCode')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.pickupStation' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="dropoffLocationCode"
              >{{ 'booking.fields.returnStation' | translate }} *</label
            >
            <ui-select-location
              id="dropoffLocationCode"
              formControlName="dropoffLocationCode"
              [placeholder]="'common.placeholders.select' | translate"
              [showCity]="true"
              [class.invalid]="
                bookingForm.get('dropoffLocationCode')?.invalid &&
                bookingForm.get('dropoffLocationCode')?.touched
              "
            />
            @if (
              bookingForm.get('dropoffLocationCode')?.invalid &&
              bookingForm.get('dropoffLocationCode')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.returnStation' | translate }}</span>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 2: Customer Information -->
    @if (currentStep() === 2) {
      <ocr-form-section
        [title]="'booking.steps.personal' | translate"
        [description]="'booking.step2.description' | translate"
        icon="user"
      >
        <div ocrFormGroup>
          <div ocrFormRow [columns]="2">
            <ocr-input
              [label]="'common.labels.firstName' | translate"
              [placeholder]="'common.placeholders.firstName' | translate"
              formControlName="firstName"
              [required]="true"
              leadingIcon="user"
              [error]="bookingForm.get('firstName')?.invalid && bookingForm.get('firstName')?.touched ? ('booking.errors.minLength2' | translate) : null"
            />
            <ocr-input
              [label]="'common.labels.lastName' | translate"
              [placeholder]="'common.placeholders.lastName' | translate"
              formControlName="lastName"
              [required]="true"
              leadingIcon="user"
              [error]="bookingForm.get('lastName')?.invalid && bookingForm.get('lastName')?.touched ? ('booking.errors.minLength2' | translate) : null"
            />
          </div>

          <ocr-input
            [label]="'common.labels.email' | translate"
            [placeholder]="'common.placeholders.email' | translate"
            type="email"
            formControlName="email"
            [required]="true"
            leadingIcon="mail"
            autocomplete="email"
            [error]="bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched ? ('booking.errors.email' | translate) : null"
          />

          <div ocrFormRow [columns]="2">
            <ocr-input
              [label]="'common.labels.phone' | translate"
              [placeholder]="'common.placeholders.phone' | translate"
              type="tel"
              formControlName="phoneNumber"
              [required]="true"
              leadingIcon="phone"
              autocomplete="tel"
              [error]="bookingForm.get('phoneNumber')?.invalid && bookingForm.get('phoneNumber')?.touched ? ('booking.errors.phone' | translate) : null"
            />
            <ocr-input
              [label]="'common.labels.dateOfBirth' | translate"
              type="date"
              formControlName="dateOfBirth"
              [required]="true"
              leadingIcon="calendar"
              [max]="today"
              [error]="bookingForm.get('dateOfBirth')?.invalid && bookingForm.get('dateOfBirth')?.touched ? ('booking.errors.dateOfBirth' | translate) : null"
            />
          </div>
        </div>
      </ocr-form-section>
    }

    <!-- Step 3: Address -->
    @if (currentStep() === 3) {
      <ocr-form-section
        [title]="'booking.steps.address' | translate"
        [description]="'booking.step3.description' | translate"
        icon="map-pin"
      >
        <div ocrFormGroup>
          <ocr-input
            [label]="'booking.fields.streetAndNumber' | translate"
            [placeholder]="'common.placeholders.street' | translate"
            formControlName="street"
            [required]="true"
            leadingIcon="home"
            autocomplete="street-address"
            [error]="bookingForm.get('street')?.invalid && bookingForm.get('street')?.touched ? ('booking.errors.minLength5' | translate) : null"
          />

          <div ocrFormRow [columns]="2">
            <ocr-input
              [label]="'common.labels.postalCode' | translate"
              [placeholder]="'common.placeholders.postalCode' | translate"
              formControlName="postalCode"
              [required]="true"
              leadingIcon="hash"
              autocomplete="postal-code"
              [error]="bookingForm.get('postalCode')?.invalid && bookingForm.get('postalCode')?.touched ? ('booking.errors.postalCode' | translate) : null"
            />
            <ocr-input
              [label]="'common.labels.city' | translate"
              [placeholder]="'common.placeholders.city' | translate"
              formControlName="city"
              [required]="true"
              leadingIcon="building"
              autocomplete="address-level2"
              [error]="bookingForm.get('city')?.invalid && bookingForm.get('city')?.touched ? ('booking.errors.minLength2' | translate) : null"
            />
          </div>

          <ocr-input
            [label]="'common.labels.country' | translate"
            formControlName="country"
            [required]="true"
            leadingIcon="globe"
            autocomplete="country-name"
            [error]="bookingForm.get('country')?.invalid && bookingForm.get('country')?.touched ? ('booking.errors.country' | translate) : null"
          />
        </div>
      </ocr-form-section>
    }

    <!-- Step 4: Driver's License -->
    @if (currentStep() === 4) {
      <ocr-form-section
        [title]="'booking.steps.license' | translate"
        [description]="'booking.step4.description' | translate"
        icon="file-text"
      >
        <div ocrFormGroup>
          <ocr-input
            [label]="'booking.fields.licenseNumber' | translate"
            [placeholder]="'common.placeholders.licenseNumber' | translate"
            formControlName="licenseNumber"
            [required]="true"
            leadingIcon="credit-card"
            [error]="bookingForm.get('licenseNumber')?.invalid && bookingForm.get('licenseNumber')?.touched ? ('booking.errors.minLength5' | translate) : null"
          />

          <ocr-input
            [label]="'booking.fields.licenseIssueCountry' | translate"
            formControlName="licenseIssueCountry"
            [required]="true"
            leadingIcon="globe"
            [error]="bookingForm.get('licenseIssueCountry')?.invalid && bookingForm.get('licenseIssueCountry')?.touched ? ('booking.errors.licenseIssueCountry' | translate) : null"
          />

          <div ocrFormRow [columns]="2">
            <ocr-input
              [label]="'booking.fields.licenseIssueDate' | translate"
              type="date"
              formControlName="licenseIssueDate"
              [required]="true"
              leadingIcon="calendar"
              [max]="maxLicenseIssueDate()"
              [error]="bookingForm.get('licenseIssueDate')?.invalid && bookingForm.get('licenseIssueDate')?.touched ? ('booking.errors.licenseIssueDate' | translate) : null"
            />
            <ocr-input
              [label]="'booking.fields.licenseExpiryDate' | translate"
              type="date"
              formControlName="licenseExpiryDate"
              [required]="true"
              leadingIcon="calendar"
              [min]="minLicenseExpiryDate()"
              [error]="bookingForm.get('licenseExpiryDate')?.invalid && bookingForm.get('licenseExpiryDate')?.touched ? ('booking.errors.licenseExpiryDate' | translate) : null"
            />
          </div>
        </div>
      </ocr-form-section>
    }

    <!-- Step 5: Review and Submit -->
    @if (currentStep() === 5) {
      <div class="form-step">
        <h2>{{ 'booking.steps.review' | translate }}</h2>
        <p class="step-description">{{ 'booking.step5.description' | translate }}</p>

        <div class="review-section">
          <h3>{{ 'booking.steps.details' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.pickupDate' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('pickupDate')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.returnDate' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('returnDate')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.review.rentalDuration' | translate }}:</span>
              <span class="review-value"
                >{{ getRentalDays() }}
                {{
                  (getRentalDays() === 1 ? 'common.labels.day' : 'common.labels.days') | translate
                }}</span
              >
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.personal' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.name' | translate }}:</span>
              <span class="review-value"
                >{{ bookingForm.get('firstName')?.value }}
                {{ bookingForm.get('lastName')?.value }}</span
              >
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.email' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('email')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.phone' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('phoneNumber')?.value }}</span>
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.address' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item full-width">
              <span class="review-label">{{ 'booking.review.address' | translate }}:</span>
              <span class="review-value">
                {{ bookingForm.get('street')?.value }}, {{ bookingForm.get('postalCode')?.value }}
                {{ bookingForm.get('city')?.value }},
                {{ bookingForm.get('country')?.value }}
              </span>
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.license' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.licenseNumber' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('licenseNumber')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.review.validUntil' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('licenseExpiryDate')?.value }}</span>
            </div>
          </div>
        </div>

        <!-- Update Profile Option (only for authenticated users) -->
        @if (isAuthenticated()) {
          <div class="profile-update-option">
            <ocr-checkbox
              [label]="'booking.review.saveToProfile' | translate"
              formControlName="updateMyProfile"
            />
            <p class="profile-update-hint">{{ 'booking.review.saveToProfileHint' | translate }}</p>
          </div>
        }
      </div>
    }

    <!-- Navigation Buttons -->
    <div class="form-navigation">
      @if (currentStep() > 1) {
        <button
          type="button"
          class="btn btn-secondary"
          (click)="previousStep()"
          [disabled]="submitting()"
        >
          <lib-icon name="chevron-left-filled" variant="filled" size="sm" />
          {{ 'common.actions.back' | translate }}
        </button>
      }

      <div class="flex-spacer"></div>

      @if (currentStep() < totalSteps) {
        <button
          type="button"
          class="btn btn-primary"
          (click)="nextStep()"
          [disabled]="!isCurrentStepValid()"
        >
          {{ 'common.actions.next' | translate }}
          <lib-icon name="chevron-right-filled" variant="filled" size="sm" />
        </button>
      }

      @if (currentStep() === totalSteps) {
        <button
          type="submit"
          class="btn btn-success"
          [disabled]="bookingForm.invalid || submitting()"
        >
          @if (submitting()) {
            <span class="spinner"></span>
            {{ 'booking.actions.submitting' | translate }}
          } @else {
            <lib-icon name="check-filled" variant="filled" size="lg" />
            {{ 'booking.actions.completeBooking' | translate }}
          }
        </button>
      }
    </div>
  </form>

  <!-- Similar Vehicles Section -->
  @if (selectedVehicle() && (similarVehicles().length > 0 || showVehicleUnavailableWarning())) {
    <div class="similar-vehicles-section">
      <app-similar-vehicles
        [currentVehicle]="selectedVehicle()"
        [similarVehicles]="similarVehicles()"
        [showUnavailableWarning]="showVehicleUnavailableWarning()"
        (vehicleSelected)="onSimilarVehicleSelected($event)"
      ></app-similar-vehicles>
    </div>
  }
</div>
