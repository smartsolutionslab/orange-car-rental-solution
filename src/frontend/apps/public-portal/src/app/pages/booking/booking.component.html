<div class="booking-container">
  <!-- Header -->
  <div class="booking-header">
    <h1>{{ 'booking.title' | translate }}</h1>
    <p class="subtitle">
      {{ 'booking.subtitle' | translate: { steps: totalSteps } }}
    </p>
  </div>

  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-steps">
      @for (step of [1, 2, 3, 4, 5]; track step) {
        <div
          class="progress-step"
          [class.active]="currentStep() >= step"
          [class.current]="currentStep() === step"
        >
          <div class="step-circle">{{ step }}</div>
          <div class="step-label">
            @switch (step) {
              @case (1) {
                {{ 'booking.steps.details' | translate }}
              }
              @case (2) {
                {{ 'booking.steps.personal' | translate }}
              }
              @case (3) {
                {{ 'booking.steps.address' | translate }}
              }
              @case (4) {
                {{ 'booking.steps.license' | translate }}
              }
              @case (5) {
                {{ 'booking.steps.review' | translate }}
              }
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <ui-error-alert [message]="error()!"></ui-error-alert>
  }

  <!-- Form -->
  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="booking-form">
    <!-- Step 1: Vehicle and Booking Details -->
    @if (currentStep() === 1) {
      <div class="form-step">
        <h2>{{ 'booking.steps.details' | translate }}</h2>
        <p class="step-description">{{ 'booking.step1.description' | translate }}</p>

        <div class="form-grid">
          <div class="form-field full-width">
            <label for="pickupDate">{{ 'booking.fields.pickupDate' | translate }} *</label>
            <input
              type="date"
              id="pickupDate"
              formControlName="pickupDate"
              [min]="today"
              [class.invalid]="
                bookingForm.get('pickupDate')?.invalid && bookingForm.get('pickupDate')?.touched
              "
            />
            @if (bookingForm.get('pickupDate')?.invalid && bookingForm.get('pickupDate')?.touched) {
              <span class="error-text">{{ 'booking.errors.pickupDate' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="returnDate">{{ 'booking.fields.returnDate' | translate }} *</label>
            <input
              type="date"
              id="returnDate"
              formControlName="returnDate"
              [min]="minReturnDate()"
              [class.invalid]="
                bookingForm.get('returnDate')?.invalid && bookingForm.get('returnDate')?.touched
              "
            />
            @if (bookingForm.get('returnDate')?.invalid && bookingForm.get('returnDate')?.touched) {
              <span class="error-text">{{ 'booking.errors.returnDate' | translate }}</span>
            }
          </div>

          @if (getRentalDays() > 0) {
            <div class="rental-info">
              <lib-icon name="clock-filled" variant="filled" size="sm" />
              <span
                >{{ getRentalDays() }}
                {{
                  (getRentalDays() === 1 ? 'common.labels.day' : 'common.labels.days') | translate
                }}</span
              >
            </div>
          }

          <div class="form-field full-width">
            <label for="pickupLocationCode"
              >{{ 'booking.fields.pickupStation' | translate }} *</label
            >
            <ui-select-location
              id="pickupLocationCode"
              formControlName="pickupLocationCode"
              [placeholder]="'common.placeholders.select' | translate"
              [showCity]="true"
              [class.invalid]="
                bookingForm.get('pickupLocationCode')?.invalid &&
                bookingForm.get('pickupLocationCode')?.touched
              "
            />
            @if (
              bookingForm.get('pickupLocationCode')?.invalid &&
              bookingForm.get('pickupLocationCode')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.pickupStation' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="dropoffLocationCode"
              >{{ 'booking.fields.returnStation' | translate }} *</label
            >
            <ui-select-location
              id="dropoffLocationCode"
              formControlName="dropoffLocationCode"
              [placeholder]="'common.placeholders.select' | translate"
              [showCity]="true"
              [class.invalid]="
                bookingForm.get('dropoffLocationCode')?.invalid &&
                bookingForm.get('dropoffLocationCode')?.touched
              "
            />
            @if (
              bookingForm.get('dropoffLocationCode')?.invalid &&
              bookingForm.get('dropoffLocationCode')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.returnStation' | translate }}</span>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 2: Customer Information -->
    @if (currentStep() === 2) {
      <div class="form-step">
        <h2>{{ 'booking.steps.personal' | translate }}</h2>
        <p class="step-description">{{ 'booking.step2.description' | translate }}</p>

        <div class="form-grid">
          <div class="form-field">
            <label for="firstName">{{ 'common.labels.firstName' | translate }} *</label>
            <input
              type="text"
              id="firstName"
              formControlName="firstName"
              [placeholder]="'common.placeholders.firstName' | translate"
              [class.invalid]="
                bookingForm.get('firstName')?.invalid && bookingForm.get('firstName')?.touched
              "
            />
            @if (bookingForm.get('firstName')?.invalid && bookingForm.get('firstName')?.touched) {
              <span class="error-text">{{ 'booking.errors.minLength2' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="lastName">{{ 'common.labels.lastName' | translate }} *</label>
            <input
              type="text"
              id="lastName"
              formControlName="lastName"
              [placeholder]="'common.placeholders.lastName' | translate"
              [class.invalid]="
                bookingForm.get('lastName')?.invalid && bookingForm.get('lastName')?.touched
              "
            />
            @if (bookingForm.get('lastName')?.invalid && bookingForm.get('lastName')?.touched) {
              <span class="error-text">{{ 'booking.errors.minLength2' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="email">{{ 'common.labels.email' | translate }} *</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              [placeholder]="'common.placeholders.email' | translate"
              [class.invalid]="
                bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched
              "
            />
            @if (bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched) {
              <span class="error-text">{{ 'booking.errors.email' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="phoneNumber">{{ 'common.labels.phone' | translate }} *</label>
            <input
              type="tel"
              id="phoneNumber"
              formControlName="phoneNumber"
              [placeholder]="'common.placeholders.phone' | translate"
              [class.invalid]="
                bookingForm.get('phoneNumber')?.invalid && bookingForm.get('phoneNumber')?.touched
              "
            />
            @if (
              bookingForm.get('phoneNumber')?.invalid && bookingForm.get('phoneNumber')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.phone' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="dateOfBirth">{{ 'common.labels.dateOfBirth' | translate }} *</label>
            <input
              type="date"
              id="dateOfBirth"
              formControlName="dateOfBirth"
              [max]="today"
              [class.invalid]="
                bookingForm.get('dateOfBirth')?.invalid && bookingForm.get('dateOfBirth')?.touched
              "
            />
            @if (
              bookingForm.get('dateOfBirth')?.invalid && bookingForm.get('dateOfBirth')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.dateOfBirth' | translate }}</span>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 3: Address -->
    @if (currentStep() === 3) {
      <div class="form-step">
        <h2>{{ 'booking.steps.address' | translate }}</h2>
        <p class="step-description">{{ 'booking.step3.description' | translate }}</p>

        <div class="form-grid">
          <div class="form-field full-width">
            <label for="street">{{ 'booking.fields.streetAndNumber' | translate }} *</label>
            <input
              type="text"
              id="street"
              formControlName="street"
              [placeholder]="'common.placeholders.street' | translate"
              [class.invalid]="
                bookingForm.get('street')?.invalid && bookingForm.get('street')?.touched
              "
            />
            @if (bookingForm.get('street')?.invalid && bookingForm.get('street')?.touched) {
              <span class="error-text">{{ 'booking.errors.minLength5' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="postalCode">{{ 'common.labels.postalCode' | translate }} *</label>
            <input
              type="text"
              id="postalCode"
              formControlName="postalCode"
              [placeholder]="'common.placeholders.postalCode' | translate"
              maxlength="5"
              [class.invalid]="
                bookingForm.get('postalCode')?.invalid && bookingForm.get('postalCode')?.touched
              "
            />
            @if (bookingForm.get('postalCode')?.invalid && bookingForm.get('postalCode')?.touched) {
              <span class="error-text">{{ 'booking.errors.postalCode' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="city">{{ 'common.labels.city' | translate }} *</label>
            <input
              type="text"
              id="city"
              formControlName="city"
              [placeholder]="'common.placeholders.city' | translate"
              [class.invalid]="bookingForm.get('city')?.invalid && bookingForm.get('city')?.touched"
            />
            @if (bookingForm.get('city')?.invalid && bookingForm.get('city')?.touched) {
              <span class="error-text">{{ 'booking.errors.minLength2' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="country">{{ 'common.labels.country' | translate }} *</label>
            <input
              type="text"
              id="country"
              formControlName="country"
              [class.invalid]="
                bookingForm.get('country')?.invalid && bookingForm.get('country')?.touched
              "
            />
            @if (bookingForm.get('country')?.invalid && bookingForm.get('country')?.touched) {
              <span class="error-text">{{ 'booking.errors.country' | translate }}</span>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 4: Driver's License -->
    @if (currentStep() === 4) {
      <div class="form-step">
        <h2>{{ 'booking.steps.license' | translate }}</h2>
        <p class="step-description">{{ 'booking.step4.description' | translate }}</p>

        <div class="form-grid">
          <div class="form-field full-width">
            <label for="licenseNumber">{{ 'booking.fields.licenseNumber' | translate }} *</label>
            <input
              type="text"
              id="licenseNumber"
              formControlName="licenseNumber"
              [placeholder]="'common.placeholders.licenseNumber' | translate"
              [class.invalid]="
                bookingForm.get('licenseNumber')?.invalid &&
                bookingForm.get('licenseNumber')?.touched
              "
            />
            @if (
              bookingForm.get('licenseNumber')?.invalid && bookingForm.get('licenseNumber')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.minLength5' | translate }}</span>
            }
          </div>

          <div class="form-field full-width">
            <label for="licenseIssueCountry"
              >{{ 'booking.fields.licenseIssueCountry' | translate }} *</label
            >
            <input
              type="text"
              id="licenseIssueCountry"
              formControlName="licenseIssueCountry"
              [class.invalid]="
                bookingForm.get('licenseIssueCountry')?.invalid &&
                bookingForm.get('licenseIssueCountry')?.touched
              "
            />
            @if (
              bookingForm.get('licenseIssueCountry')?.invalid &&
              bookingForm.get('licenseIssueCountry')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.licenseIssueCountry' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="licenseIssueDate"
              >{{ 'booking.fields.licenseIssueDate' | translate }} *</label
            >
            <input
              type="date"
              id="licenseIssueDate"
              formControlName="licenseIssueDate"
              [max]="maxLicenseIssueDate()"
              [class.invalid]="
                bookingForm.get('licenseIssueDate')?.invalid &&
                bookingForm.get('licenseIssueDate')?.touched
              "
            />
            @if (
              bookingForm.get('licenseIssueDate')?.invalid &&
              bookingForm.get('licenseIssueDate')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.licenseIssueDate' | translate }}</span>
            }
          </div>

          <div class="form-field">
            <label for="licenseExpiryDate"
              >{{ 'booking.fields.licenseExpiryDate' | translate }} *</label
            >
            <input
              type="date"
              id="licenseExpiryDate"
              formControlName="licenseExpiryDate"
              [min]="minLicenseExpiryDate()"
              [class.invalid]="
                bookingForm.get('licenseExpiryDate')?.invalid &&
                bookingForm.get('licenseExpiryDate')?.touched
              "
            />
            @if (
              bookingForm.get('licenseExpiryDate')?.invalid &&
              bookingForm.get('licenseExpiryDate')?.touched
            ) {
              <span class="error-text">{{ 'booking.errors.licenseExpiryDate' | translate }}</span>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 5: Review and Submit -->
    @if (currentStep() === 5) {
      <div class="form-step">
        <h2>{{ 'booking.steps.review' | translate }}</h2>
        <p class="step-description">{{ 'booking.step5.description' | translate }}</p>

        <div class="review-section">
          <h3>{{ 'booking.steps.details' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.pickupDate' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('pickupDate')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.returnDate' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('returnDate')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.review.rentalDuration' | translate }}:</span>
              <span class="review-value"
                >{{ getRentalDays() }}
                {{
                  (getRentalDays() === 1 ? 'common.labels.day' : 'common.labels.days') | translate
                }}</span
              >
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.personal' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.name' | translate }}:</span>
              <span class="review-value"
                >{{ bookingForm.get('firstName')?.value }}
                {{ bookingForm.get('lastName')?.value }}</span
              >
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.email' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('email')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'common.labels.phone' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('phoneNumber')?.value }}</span>
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.address' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item full-width">
              <span class="review-label">{{ 'booking.review.address' | translate }}:</span>
              <span class="review-value">
                {{ bookingForm.get('street')?.value }}, {{ bookingForm.get('postalCode')?.value }}
                {{ bookingForm.get('city')?.value }},
                {{ bookingForm.get('country')?.value }}
              </span>
            </div>
          </div>
        </div>

        <div class="review-section">
          <h3>{{ 'booking.steps.license' | translate }}</h3>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-label">{{ 'booking.fields.licenseNumber' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('licenseNumber')?.value }}</span>
            </div>
            <div class="review-item">
              <span class="review-label">{{ 'booking.review.validUntil' | translate }}:</span>
              <span class="review-value">{{ bookingForm.get('licenseExpiryDate')?.value }}</span>
            </div>
          </div>
        </div>

        <!-- Update Profile Option (only for authenticated users) -->
        @if (isAuthenticated()) {
          <div class="profile-update-option">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="updateMyProfile" class="checkbox-input" />
              <span class="checkbox-text">{{ 'booking.review.saveToProfile' | translate }}</span>
            </label>
            <p class="profile-update-hint">{{ 'booking.review.saveToProfileHint' | translate }}</p>
          </div>
        }
      </div>
    }

    <!-- Navigation Buttons -->
    <div class="form-navigation">
      @if (currentStep() > 1) {
        <button
          type="button"
          class="btn btn-secondary"
          (click)="previousStep()"
          [disabled]="submitting()"
        >
          <lib-icon name="chevron-left-filled" variant="filled" size="sm" />
          {{ 'common.actions.back' | translate }}
        </button>
      }

      <div class="flex-spacer"></div>

      @if (currentStep() < totalSteps) {
        <button
          type="button"
          class="btn btn-primary"
          (click)="nextStep()"
          [disabled]="!isCurrentStepValid()"
        >
          {{ 'common.actions.next' | translate }}
          <lib-icon name="chevron-right-filled" variant="filled" size="sm" />
        </button>
      }

      @if (currentStep() === totalSteps) {
        <button
          type="submit"
          class="btn btn-success"
          [disabled]="bookingForm.invalid || submitting()"
        >
          @if (submitting()) {
            <span class="spinner"></span>
            {{ 'booking.actions.submitting' | translate }}
          } @else {
            <lib-icon name="check-filled" variant="filled" size="lg" />
            {{ 'booking.actions.completeBooking' | translate }}
          }
        </button>
      }
    </div>
  </form>

  <!-- Similar Vehicles Section -->
  @if (selectedVehicle() && (similarVehicles().length > 0 || showVehicleUnavailableWarning())) {
    <div class="similar-vehicles-section">
      <app-similar-vehicles
        [currentVehicle]="selectedVehicle()"
        [similarVehicles]="similarVehicles()"
        [showUnavailableWarning]="showVehicleUnavailableWarning()"
        (vehicleSelected)="onSimilarVehicleSelected($event)"
      ></app-similar-vehicles>
    </div>
  }
</div>
