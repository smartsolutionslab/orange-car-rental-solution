<div class="page-header">
  <h1>Kundenverwaltung</h1>
  <p class="subtitle">Suchen und verwalten Sie Kundeninformationen</p>
</div>

<div class="content-section">
  <div class="section-header">
    <h2>Kundensuche</h2>
  </div>

  <!-- Search Form -->
  <div class="search-section">
    <div class="search-grid">
      <div class="search-field">
        <label for="searchEmail">E-Mail</label>
        <input
          type="email"
          id="searchEmail"
          [(ngModel)]="searchEmail"
          placeholder="kunde@beispiel.de"
          (keyup.enter)="searchCustomers()"
        />
      </div>

      <div class="search-field">
        <label for="searchPhone">Telefonnummer</label>
        <input
          type="tel"
          id="searchPhone"
          [(ngModel)]="searchPhone"
          placeholder="+49 123 456789"
          (keyup.enter)="searchCustomers()"
        />
      </div>

      <div class="search-field">
        <label for="searchLastName">Nachname</label>
        <input
          type="text"
          id="searchLastName"
          [(ngModel)]="searchLastName"
          placeholder="Mustermann"
          (keyup.enter)="searchCustomers()"
        />
      </div>
    </div>

    <div class="search-actions">
      <button class="btn-primary" (click)="searchCustomers()" [disabled]="loading()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        Suchen
      </button>
      <button class="btn-secondary" (click)="clearSearch()" [disabled]="loading()">
        Zurücksetzen
      </button>
    </div>

    @if (error()) {
      <div class="search-error">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        {{ error() }}
      </div>
    }
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Suche nach Kunden...</p>
    </div>
  }

  <!-- Search Results -->
  @if (!loading() && searchPerformed() && customers().length > 0) {
    <div class="results-header">
      <h3>Suchergebnisse</h3>
      <span class="results-count">{{ totalCustomers() }} Kunde(n) gefunden</span>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>E-Mail</th>
            <th>Telefon</th>
            <th>Geburtsdatum</th>
            <th>Stadt</th>
            <th>Registriert</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          @for (customer of customers(); track customer.id) {
            <tr>
              <td>{{ customer.firstName }} {{ customer.lastName }}</td>
              <td>{{ customer.email }}</td>
              <td>{{ customer.phoneNumber }}</td>
              <td>{{ formatDate(customer.dateOfBirth) }}</td>
              <td>{{ customer.city }}</td>
              <td>{{ formatDate(customer.createdAt) }}</td>
              <td>
                <button class="btn-icon" (click)="viewDetails(customer)" title="Details anzeigen">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- No Results -->
  @if (!loading() && searchPerformed() && customers().length === 0) {
    <div class="no-results">
      <svg class="no-results-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
      <h3>Keine Kunden gefunden</h3>
      <p>Versuchen Sie es mit anderen Suchkriterien.</p>
    </div>
  }

  <!-- Initial State -->
  @if (!loading() && !searchPerformed()) {
    <div class="initial-state">
      <svg class="initial-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
      <h3>Kundensuche</h3>
      <p>Geben Sie mindestens ein Suchkriterium ein, um Kunden zu finden.</p>
      <p class="hint">Tipp: Sie können nach E-Mail, Telefonnummer oder Nachname suchen.</p>
    </div>
  }
</div>

<!-- Customer Details Modal -->
@if (showDetails() && selectedCustomer()) {
  <div class="modal-overlay" (click)="closeDetails()">
    <div class="modal-content modal-content-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Kundendetails</h2>
        <button class="btn-close" (click)="closeDetails()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Customer Information -->
        <div class="info-section">
          <h3>Persönliche Informationen</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Kunden-ID</label>
              <p><span class="id-badge">{{ selectedCustomer()!.id }}</span></p>
            </div>
            <div class="detail-item">
              <label>Name</label>
              <p>{{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}</p>
            </div>
            <div class="detail-item">
              <label>E-Mail</label>
              <p>{{ selectedCustomer()!.email }}</p>
            </div>
            <div class="detail-item">
              <label>Telefon</label>
              <p>{{ selectedCustomer()!.phoneNumber }}</p>
            </div>
            <div class="detail-item">
              <label>Geburtsdatum</label>
              <p>{{ formatDate(selectedCustomer()!.dateOfBirth) }} ({{ calculateAge(selectedCustomer()!.dateOfBirth) }} Jahre)</p>
            </div>
            <div class="detail-item">
              <label>Registriert seit</label>
              <p>{{ formatDate(selectedCustomer()!.createdAt) }}</p>
            </div>
          </div>
        </div>

        <!-- Address Information -->
        <div class="info-section">
          <h3>Adresse</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Straße</label>
              <p>{{ selectedCustomer()!.street }}</p>
            </div>
            <div class="detail-item">
              <label>Stadt</label>
              <p>{{ selectedCustomer()!.city }}</p>
            </div>
            <div class="detail-item">
              <label>Postleitzahl</label>
              <p>{{ selectedCustomer()!.postalCode }}</p>
            </div>
            <div class="detail-item">
              <label>Land</label>
              <p>{{ selectedCustomer()!.country }}</p>
            </div>
          </div>
        </div>

        <!-- Driver's License Information -->
        <div class="info-section">
          <h3>Führerschein</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Führerscheinnummer</label>
              <p>{{ selectedCustomer()!.licenseNumber }}</p>
            </div>
            <div class="detail-item">
              <label>Ausstellungsland</label>
              <p>{{ selectedCustomer()!.licenseIssueCountry }}</p>
            </div>
            <div class="detail-item">
              <label>Ausstellungsdatum</label>
              <p>{{ formatDate(selectedCustomer()!.licenseIssueDate) }}</p>
            </div>
            <div class="detail-item">
              <label>Ablaufdatum</label>
              <p>{{ formatDate(selectedCustomer()!.licenseExpiryDate) }}</p>
            </div>
          </div>
        </div>

        <!-- Customer Reservations -->
        <div class="info-section">
          <h3>Reservierungen ({{ customerReservations().length }})</h3>

          @if (loadingReservations()) {
            <div class="loading-small">
              <div class="loading-spinner-small"></div>
              <p>Lade Reservierungen...</p>
            </div>
          }

          @if (!loadingReservations() && customerReservations().length > 0) {
            <div class="reservations-list">
              @for (reservation of customerReservations(); track reservation.reservationId) {
                <div class="reservation-card">
                  <div class="reservation-header">
                    <span class="id-badge">{{ reservation.reservationId.substring(0, 8) }}</span>
                    <span class="status-badge" [ngClass]="getStatusClass(reservation.status)">{{ reservation.status }}</span>
                  </div>
                  <div class="reservation-details">
                    <div class="reservation-row">
                      <span class="label">Zeitraum:</span>
                      <span>{{ formatDate(reservation.pickupDate) }} - {{ formatDate(reservation.returnDate) }}</span>
                    </div>
                    <div class="reservation-row">
                      <span class="label">Dauer:</span>
                      <span>{{ reservation.rentalDays }} Tag(e)</span>
                    </div>
                    <div class="reservation-row">
                      <span class="label">Abholort:</span>
                      <span>{{ reservation.pickupLocationCode }}</span>
                    </div>
                    <div class="reservation-row">
                      <span class="label">Preis:</span>
                      <span><strong>{{ reservation.totalPriceGross.toFixed(2) }} {{ reservation.currency }}</strong></span>
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          @if (!loadingReservations() && customerReservations().length === 0) {
            <p class="no-data">Keine Reservierungen gefunden</p>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDetails()">Schließen</button>
      </div>
    </div>
  </div>
}
