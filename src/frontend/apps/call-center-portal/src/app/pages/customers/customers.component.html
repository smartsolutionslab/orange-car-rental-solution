<div class="page-header">
  <h1>{{ 'customers.title' | translate }}</h1>
  <p class="subtitle">{{ 'customers.subtitle' | translate }}</p>
</div>

<div class="content-section">
  <div class="section-header">
    <h2>{{ 'customers.search.title' | translate }}</h2>
  </div>

  <!-- Search Form -->
  <div class="search-section">
    <div class="search-grid">
      <ocr-input
        [label]="'customers.search.email' | translate"
        type="email"
        [(ngModel)]="searchEmail"
        [placeholder]="'common.placeholders.email' | translate"
        leadingIcon="mail"
        (keyup.enter)="searchCustomers()"
      />

      <ocr-input
        [label]="'customers.search.phone' | translate"
        type="tel"
        [(ngModel)]="searchPhone"
        placeholder="+49 123 456789"
        leadingIcon="phone"
        (keyup.enter)="searchCustomers()"
      />

      <ocr-input
        [label]="'customers.search.name' | translate"
        type="text"
        [(ngModel)]="searchName"
        [placeholder]="'common.placeholders.name' | translate"
        leadingIcon="user"
        (keyup.enter)="searchCustomers()"
      />
    </div>

    <div class="search-actions">
      <button class="btn-primary" (click)="searchCustomers()" [disabled]="loading()">
        <lib-icon name="search-filled" variant="filled" size="sm" aria-hidden="true" />
        {{ 'customers.search.button' | translate }}
      </button>
      <button class="btn-secondary" (click)="clearSearch()" [disabled]="loading()">
        {{ 'common.actions.reset' | translate }}
      </button>
    </div>

    @if (error()) {
      <ui-error-state [message]="error()!" variant="inline"></ui-error-state>
    }
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <ui-loading-state [message]="'customers.search.searching' | translate"></ui-loading-state>
  }

  <!-- Search Results -->
  @if (!loading() && searchPerformed() && customers().length > 0) {
    <div class="results-header">
      <h3>{{ 'customers.results.title' | translate }}</h3>
      <span class="results-count">{{
        'customers.results.found' | translate: { count: totalCustomers() }
      }}</span>
    </div>

    <ocr-data-table
      [data]="customers()"
      [rowClickable]="true"
      (rowClick)="viewDetails($event.item)"
    >
      <ng-template ocrDataTableColumn="name" [header]="'customers.table.name' | translate" let-row>
        {{ row.firstName }} {{ row.lastName }}
      </ng-template>

      <ng-template ocrDataTableColumn="email" [header]="'customers.table.email' | translate" let-row>
        {{ row.email }}
      </ng-template>

      <ng-template ocrDataTableColumn="phoneNumber" [header]="'customers.table.phone' | translate" let-row>
        {{ row.phoneNumber }}
      </ng-template>

      <ng-template ocrDataTableColumn="dateOfBirth" [header]="'customers.table.dateOfBirth' | translate" let-row>
        {{ formatDate(row.dateOfBirth) }}
      </ng-template>

      <ng-template ocrDataTableColumn="city" [header]="'customers.table.city' | translate" let-row>
        {{ row.address?.city }}
      </ng-template>

      <ng-template ocrDataTableColumn="createdAt" [header]="'customers.table.registered' | translate" let-row>
        {{ formatDate(row.registeredAtUtc) }}
      </ng-template>

      <ng-template ocrDataTableColumn="actions" [header]="'customers.table.actions' | translate" let-row>
        <button
          class="btn-icon"
          (click)="viewDetails(row); $event.stopPropagation()"
          [title]="'common.actions.viewDetails' | translate"
          [attr.aria-label]="'common.actions.viewDetails' | translate"
        >
          <lib-icon name="eye-filled" variant="filled" size="sm" aria-hidden="true" />
        </button>
      </ng-template>
    </ocr-data-table>
  }

  <!-- No Results -->
  @if (!loading() && searchPerformed() && customers().length === 0) {
    <ui-empty-state
      icon="search"
      [title]="'customers.results.noResults' | translate"
      [description]="'customers.search.minCriteria' | translate"
    ></ui-empty-state>
  }

  <!-- Initial State -->
  @if (!loading() && !searchPerformed()) {
    <ui-empty-state
      icon="search"
      [title]="'customers.search.title' | translate"
      [description]="'customers.search.minCriteria' | translate"
    ></ui-empty-state>
  }
</div>

<!-- Customer Details Modal -->
<ui-modal
  [isOpen]="showDetails() && !!selectedCustomer()"
  [title]="
    editMode() ? ('customers.edit.title' | translate) : ('customers.details.title' | translate)
  "
  size="lg"
  (close)="closeDetails()"
>
  <ng-container modal-body>
    @if (selectedCustomer()) {
      <!-- Success Message -->
      @if (successMessage()) {
        <ui-success-alert [message]="successMessage()!"></ui-success-alert>
      }
      <!-- Customer Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.personalInfo' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'customers.details.customerId' | translate }}</label>
              <p>
                <span class="id-badge">{{ selectedCustomer()!.id }}</span>
              </p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.table.name' | translate }}</label>
              <p>{{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.email' | translate }}</label>
              <p>{{ selectedCustomer()!.email }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.phone' | translate }}</label>
              <p>{{ selectedCustomer()!.phoneNumber }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.dateOfBirth' | translate }}</label>
              <p>
                {{ formatDate(selectedCustomer()!.dateOfBirth) }} ({{
                  calculateAge(selectedCustomer()!.dateOfBirth)
                }}
                Jahre)
              </p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.registered' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.registeredAtUtc) }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <ocr-input
              [label]="'common.labels.firstName' | translate"
              type="text"
              [ngModel]="editForm().firstName"
              (ngModelChange)="updateEditForm('firstName', $event)"
              [required]="true"
            />
            <ocr-input
              [label]="'common.labels.lastName' | translate"
              type="text"
              [ngModel]="editForm().lastName"
              (ngModelChange)="updateEditForm('lastName', $event)"
              [required]="true"
            />
            <ocr-input
              [label]="'common.labels.email' | translate"
              type="email"
              [ngModel]="editForm().email"
              (ngModelChange)="updateEditForm('email', $event)"
              [required]="true"
            />
            <ocr-input
              [label]="'common.labels.phone' | translate"
              type="tel"
              [ngModel]="editForm().phoneNumber"
              (ngModelChange)="updateEditForm('phoneNumber', $event)"
              [required]="true"
            />
            <ocr-input
              [label]="'common.labels.dateOfBirth' | translate"
              type="date"
              [ngModel]="editForm().dateOfBirth"
              (ngModelChange)="updateEditForm('dateOfBirth', $event)"
              [required]="true"
            />
          </div>
        }
      </div>

      <!-- Address Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.address' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'common.labels.street' | translate }}</label>
              <p>{{ selectedCustomer()!.address?.street }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.city' | translate }}</label>
              <p>{{ selectedCustomer()!.address?.city }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.postalCode' | translate }}</label>
              <p>{{ selectedCustomer()!.address?.postalCode }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.country' | translate }}</label>
              <p>{{ selectedCustomer()!.address?.country }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <ocr-input
              [label]="'common.labels.street' | translate"
              type="text"
              [ngModel]="editForm().street"
              (ngModelChange)="updateEditForm('street', $event)"
            />
            <ocr-input
              [label]="'common.labels.city' | translate"
              type="text"
              [ngModel]="editForm().city"
              (ngModelChange)="updateEditForm('city', $event)"
            />
            <ocr-input
              [label]="'common.labels.postalCode' | translate"
              type="text"
              [ngModel]="editForm().postalCode"
              (ngModelChange)="updateEditForm('postalCode', $event)"
            />
            <ocr-input
              [label]="'common.labels.country' | translate"
              type="text"
              [ngModel]="editForm().country"
              (ngModelChange)="updateEditForm('country', $event)"
            />
          </div>
        }
      </div>

      <!-- Driver's License Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.license.title' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'customers.details.license.number' | translate }}</label>
              <p>{{ selectedCustomer()!.driversLicense?.licenseNumber }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.issueCountry' | translate }}</label>
              <p>{{ selectedCustomer()!.driversLicense?.issueCountry }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.issueDate' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.driversLicense?.issueDate) }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.expiryDate' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.driversLicense?.expiryDate) }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <ocr-input
              [label]="'customers.details.license.number' | translate"
              type="text"
              [ngModel]="editForm().licenseNumber"
              (ngModelChange)="updateEditForm('licenseNumber', $event)"
              [required]="true"
            />
            <ocr-input
              [label]="'customers.details.license.issueCountry' | translate"
              type="text"
              [ngModel]="editForm().licenseIssueCountry"
              (ngModelChange)="updateEditForm('licenseIssueCountry', $event)"
            />
            <ocr-input
              [label]="'customers.details.license.issueDate' | translate"
              type="date"
              [ngModel]="editForm().licenseIssueDate"
              (ngModelChange)="updateEditForm('licenseIssueDate', $event)"
            />
            <ocr-input
              [label]="'customers.details.license.expiryDate' | translate"
              type="date"
              [ngModel]="editForm().licenseExpiryDate"
              (ngModelChange)="updateEditForm('licenseExpiryDate', $event)"
            />
          </div>
        }
      </div>

      <!-- Customer Reservations -->
      <div class="info-section">
        <h3>
          {{ 'customers.details.reservations.title' | translate }} ({{
            customerReservations().length
          }})
        </h3>

        @if (loadingReservations()) {
          <ui-loading-state
            size="sm"
            [message]="'customers.details.reservations.loading' | translate"
          ></ui-loading-state>
        }

        @if (!loadingReservations() && customerReservations().length > 0) {
          <div class="reservations-list">
            @for (reservation of customerReservations(); track reservation.reservationId) {
              <div class="reservation-card">
                <div class="reservation-header">
                  <span class="id-badge">{{ reservation.reservationId.substring(0, 8) }}</span>
                  <ui-status-badge
                    type="reservation"
                    [status]="reservation.status"
                  ></ui-status-badge>
                </div>
                <div class="reservation-details">
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.period' | translate }}:</span
                    >
                    <span
                      >{{ formatDate(reservation.pickupDate) }} -
                      {{ formatDate(reservation.returnDate) }}</span
                    >
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.duration' | translate }}:</span
                    >
                    <span
                      >{{ reservation.rentalDays }}
                      {{ 'customers.details.reservations.days' | translate }}</span
                    >
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.pickupLocation' | translate }}:</span
                    >
                    <span>{{ reservation.pickupLocationCode }}</span>
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.price' | translate }}:</span
                    >
                    <span
                      ><strong
                        >{{ reservation.totalPriceGross.toFixed(2) }}
                        {{ reservation.currency }}</strong
                      ></span
                    >
                  </div>
                </div>
              </div>
            }
          </div>
        }

        @if (!loadingReservations() && customerReservations().length === 0) {
          <p class="no-data">{{ 'customers.details.reservations.noResults' | translate }}</p>
        }
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    @if (!editMode()) {
      <button class="btn-secondary" (click)="closeDetails()">
        {{ 'common.actions.close' | translate }}
      </button>
      <button class="btn-primary" (click)="enterEditMode()">
        <lib-icon name="pencil-filled" variant="filled" size="sm" aria-hidden="true" />
        {{ 'common.actions.edit' | translate }}
      </button>
    } @else {
      <button class="btn-secondary" (click)="cancelEdit()" [disabled]="saving()">
        {{ 'common.actions.cancel' | translate }}
      </button>
      <button class="btn-primary" (click)="saveCustomer()" [disabled]="saving()">
        @if (saving()) {
          <span class="loading-spinner-small"></span>
        }
        {{ 'common.actions.save' | translate }}
      </button>
    }
  </ng-container>
</ui-modal>
