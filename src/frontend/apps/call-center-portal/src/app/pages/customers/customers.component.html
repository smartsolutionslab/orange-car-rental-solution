<div class="page-header">
  <h1>{{ 'customers.title' | translate }}</h1>
  <p class="subtitle">{{ 'customers.subtitle' | translate }}</p>
</div>

<div class="content-section">
  <div class="section-header">
    <h2>{{ 'customers.search.title' | translate }}</h2>
  </div>

  <!-- Search Form -->
  <div class="search-section">
    <div class="search-grid">
      <div class="search-field">
        <label for="searchEmail">{{ 'customers.search.email' | translate }}</label>
        <input
          type="email"
          id="searchEmail"
          [(ngModel)]="searchEmail"
          [placeholder]="'common.placeholders.email' | translate"
          (keyup.enter)="searchCustomers()"
        />
      </div>

      <div class="search-field">
        <label for="searchPhone">{{ 'customers.search.phone' | translate }}</label>
        <input
          type="tel"
          id="searchPhone"
          [(ngModel)]="searchPhone"
          placeholder="+49 123 456789"
          (keyup.enter)="searchCustomers()"
        />
      </div>

      <div class="search-field">
        <label for="searchLastName">{{ 'customers.search.lastName' | translate }}</label>
        <input
          type="text"
          id="searchLastName"
          [(ngModel)]="searchLastName"
          [placeholder]="'common.placeholders.lastName' | translate"
          (keyup.enter)="searchCustomers()"
        />
      </div>
    </div>

    <div class="search-actions">
      <button class="btn-primary" (click)="searchCustomers()" [disabled]="loading()">
        <lib-icon name="search-filled" variant="filled" size="sm" aria-hidden="true" />
        {{ 'customers.search.button' | translate }}
      </button>
      <button class="btn-secondary" (click)="clearSearch()" [disabled]="loading()">
        {{ 'common.actions.reset' | translate }}
      </button>
    </div>

    @if (error()) {
      <ui-error-state [message]="error()!" variant="inline"></ui-error-state>
    }
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <ui-loading-state [message]="'customers.search.searching' | translate"></ui-loading-state>
  }

  <!-- Search Results -->
  @if (!loading() && searchPerformed() && customers().length > 0) {
    <div class="results-header">
      <h3>{{ 'customers.results.title' | translate }}</h3>
      <span class="results-count">{{
        'customers.results.found' | translate: { count: totalCustomers() }
      }}</span>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th scope="col">{{ 'customers.table.name' | translate }}</th>
            <th scope="col">{{ 'customers.table.email' | translate }}</th>
            <th scope="col">{{ 'customers.table.phone' | translate }}</th>
            <th scope="col">{{ 'customers.table.dateOfBirth' | translate }}</th>
            <th scope="col">{{ 'customers.table.city' | translate }}</th>
            <th scope="col">{{ 'customers.table.registered' | translate }}</th>
            <th scope="col">{{ 'customers.table.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          @for (customer of customers(); track customer.id) {
            <tr>
              <td>{{ customer.firstName }} {{ customer.lastName }}</td>
              <td>{{ customer.email }}</td>
              <td>{{ customer.phoneNumber }}</td>
              <td>{{ formatDate(customer.dateOfBirth) }}</td>
              <td>{{ customer.city }}</td>
              <td>{{ formatDate(customer.createdAt) }}</td>
              <td>
                <button
                  class="btn-icon"
                  (click)="viewDetails(customer)"
                  [title]="'common.actions.viewDetails' | translate"
                  [attr.aria-label]="'common.actions.viewDetails' | translate"
                >
                  <lib-icon name="eye-filled" variant="filled" size="sm" aria-hidden="true" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- No Results -->
  @if (!loading() && searchPerformed() && customers().length === 0) {
    <ui-empty-state
      icon="search"
      [title]="'customers.results.noResults' | translate"
      [description]="'customers.search.minCriteria' | translate"
    ></ui-empty-state>
  }

  <!-- Initial State -->
  @if (!loading() && !searchPerformed()) {
    <ui-empty-state
      icon="search"
      [title]="'customers.search.title' | translate"
      [description]="'customers.search.minCriteria' | translate"
    ></ui-empty-state>
  }
</div>

<!-- Customer Details Modal -->
<ui-modal
  [isOpen]="showDetails() && !!selectedCustomer()"
  [title]="
    editMode() ? ('customers.edit.title' | translate) : ('customers.details.title' | translate)
  "
  size="lg"
  (close)="closeDetails()"
>
  <ng-container modal-body>
    @if (selectedCustomer()) {
      <!-- Success Message -->
      @if (successMessage()) {
        <ui-success-alert [message]="successMessage()!"></ui-success-alert>
      }
      <!-- Customer Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.personalInfo' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'customers.details.customerId' | translate }}</label>
              <p>
                <span class="id-badge">{{ selectedCustomer()!.id }}</span>
              </p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.table.name' | translate }}</label>
              <p>{{ selectedCustomer()!.firstName }} {{ selectedCustomer()!.lastName }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.email' | translate }}</label>
              <p>{{ selectedCustomer()!.email }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.phone' | translate }}</label>
              <p>{{ selectedCustomer()!.phoneNumber }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.dateOfBirth' | translate }}</label>
              <p>
                {{ formatDate(selectedCustomer()!.dateOfBirth) }} ({{
                  calculateAge(selectedCustomer()!.dateOfBirth)
                }}
                Jahre)
              </p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.registered' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.createdAt) }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <div class="form-field">
              <label for="editFirstName">{{ 'common.labels.firstName' | translate }} *</label>
              <input
                type="text"
                id="editFirstName"
                [ngModel]="editForm().firstName"
                (ngModelChange)="updateEditForm('firstName', $event)"
                required
              />
            </div>
            <div class="form-field">
              <label for="editLastName">{{ 'common.labels.lastName' | translate }} *</label>
              <input
                type="text"
                id="editLastName"
                [ngModel]="editForm().lastName"
                (ngModelChange)="updateEditForm('lastName', $event)"
                required
              />
            </div>
            <div class="form-field">
              <label for="editEmail">{{ 'common.labels.email' | translate }} *</label>
              <input
                type="email"
                id="editEmail"
                [ngModel]="editForm().email"
                (ngModelChange)="updateEditForm('email', $event)"
                required
              />
            </div>
            <div class="form-field">
              <label for="editPhone">{{ 'common.labels.phone' | translate }} *</label>
              <input
                type="tel"
                id="editPhone"
                [ngModel]="editForm().phoneNumber"
                (ngModelChange)="updateEditForm('phoneNumber', $event)"
                required
              />
            </div>
            <div class="form-field">
              <label for="editDateOfBirth">{{ 'common.labels.dateOfBirth' | translate }} *</label>
              <input
                type="date"
                id="editDateOfBirth"
                [ngModel]="editForm().dateOfBirth"
                (ngModelChange)="updateEditForm('dateOfBirth', $event)"
                required
              />
            </div>
          </div>
        }
      </div>

      <!-- Address Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.address' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'common.labels.street' | translate }}</label>
              <p>{{ selectedCustomer()!.street }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.city' | translate }}</label>
              <p>{{ selectedCustomer()!.city }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.postalCode' | translate }}</label>
              <p>{{ selectedCustomer()!.postalCode }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'common.labels.country' | translate }}</label>
              <p>{{ selectedCustomer()!.country }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <div class="form-field">
              <label for="editStreet">{{ 'common.labels.street' | translate }}</label>
              <input
                type="text"
                id="editStreet"
                [ngModel]="editForm().street"
                (ngModelChange)="updateEditForm('street', $event)"
              />
            </div>
            <div class="form-field">
              <label for="editCity">{{ 'common.labels.city' | translate }}</label>
              <input
                type="text"
                id="editCity"
                [ngModel]="editForm().city"
                (ngModelChange)="updateEditForm('city', $event)"
              />
            </div>
            <div class="form-field">
              <label for="editPostalCode">{{ 'common.labels.postalCode' | translate }}</label>
              <input
                type="text"
                id="editPostalCode"
                [ngModel]="editForm().postalCode"
                (ngModelChange)="updateEditForm('postalCode', $event)"
              />
            </div>
            <div class="form-field">
              <label for="editCountry">{{ 'common.labels.country' | translate }}</label>
              <input
                type="text"
                id="editCountry"
                [ngModel]="editForm().country"
                (ngModelChange)="updateEditForm('country', $event)"
              />
            </div>
          </div>
        }
      </div>

      <!-- Driver's License Information -->
      <div class="info-section">
        <h3>{{ 'customers.details.license.title' | translate }}</h3>

        @if (!editMode()) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>{{ 'customers.details.license.number' | translate }}</label>
              <p>{{ selectedCustomer()!.licenseNumber }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.issueCountry' | translate }}</label>
              <p>{{ selectedCustomer()!.licenseIssueCountry }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.issueDate' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.licenseIssueDate) }}</p>
            </div>
            <div class="detail-item">
              <label>{{ 'customers.details.license.expiryDate' | translate }}</label>
              <p>{{ formatDate(selectedCustomer()!.licenseExpiryDate) }}</p>
            </div>
          </div>
        } @else {
          <div class="form-grid">
            <div class="form-field">
              <label for="editLicenseNumber"
                >{{ 'customers.details.license.number' | translate }} *</label
              >
              <input
                type="text"
                id="editLicenseNumber"
                [ngModel]="editForm().licenseNumber"
                (ngModelChange)="updateEditForm('licenseNumber', $event)"
                required
              />
            </div>
            <div class="form-field">
              <label for="editLicenseCountry">{{
                'customers.details.license.issueCountry' | translate
              }}</label>
              <input
                type="text"
                id="editLicenseCountry"
                [ngModel]="editForm().licenseIssueCountry"
                (ngModelChange)="updateEditForm('licenseIssueCountry', $event)"
              />
            </div>
            <div class="form-field">
              <label for="editLicenseIssueDate">{{
                'customers.details.license.issueDate' | translate
              }}</label>
              <input
                type="date"
                id="editLicenseIssueDate"
                [ngModel]="editForm().licenseIssueDate"
                (ngModelChange)="updateEditForm('licenseIssueDate', $event)"
              />
            </div>
            <div class="form-field">
              <label for="editLicenseExpiryDate">{{
                'customers.details.license.expiryDate' | translate
              }}</label>
              <input
                type="date"
                id="editLicenseExpiryDate"
                [ngModel]="editForm().licenseExpiryDate"
                (ngModelChange)="updateEditForm('licenseExpiryDate', $event)"
              />
            </div>
          </div>
        }
      </div>

      <!-- Customer Reservations -->
      <div class="info-section">
        <h3>
          {{ 'customers.details.reservations.title' | translate }} ({{
            customerReservations().length
          }})
        </h3>

        @if (loadingReservations()) {
          <ui-loading-state
            size="sm"
            [message]="'customers.details.reservations.loading' | translate"
          ></ui-loading-state>
        }

        @if (!loadingReservations() && customerReservations().length > 0) {
          <div class="reservations-list">
            @for (reservation of customerReservations(); track reservation.reservationId) {
              <div class="reservation-card">
                <div class="reservation-header">
                  <span class="id-badge">{{ reservation.reservationId.substring(0, 8) }}</span>
                  <ui-status-badge
                    type="reservation"
                    [status]="reservation.status"
                  ></ui-status-badge>
                </div>
                <div class="reservation-details">
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.period' | translate }}:</span
                    >
                    <span
                      >{{ formatDate(reservation.pickupDate) }} -
                      {{ formatDate(reservation.returnDate) }}</span
                    >
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.duration' | translate }}:</span
                    >
                    <span
                      >{{ reservation.rentalDays }}
                      {{ 'customers.details.reservations.days' | translate }}</span
                    >
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.pickupLocation' | translate }}:</span
                    >
                    <span>{{ reservation.pickupLocationCode }}</span>
                  </div>
                  <div class="reservation-row">
                    <span class="label"
                      >{{ 'customers.details.reservations.price' | translate }}:</span
                    >
                    <span
                      ><strong
                        >{{ reservation.totalPriceGross.toFixed(2) }}
                        {{ reservation.currency }}</strong
                      ></span
                    >
                  </div>
                </div>
              </div>
            }
          </div>
        }

        @if (!loadingReservations() && customerReservations().length === 0) {
          <p class="no-data">{{ 'customers.details.reservations.noResults' | translate }}</p>
        }
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    @if (!editMode()) {
      <button class="btn-secondary" (click)="closeDetails()">
        {{ 'common.actions.close' | translate }}
      </button>
      <button class="btn-primary" (click)="enterEditMode()">
        <lib-icon name="pencil-filled" variant="filled" size="sm" aria-hidden="true" />
        {{ 'common.actions.edit' | translate }}
      </button>
    } @else {
      <button class="btn-secondary" (click)="cancelEdit()" [disabled]="saving()">
        {{ 'common.actions.cancel' | translate }}
      </button>
      <button class="btn-primary" (click)="saveCustomer()" [disabled]="saving()">
        @if (saving()) {
          <span class="loading-spinner-small"></span>
        }
        {{ 'common.actions.save' | translate }}
      </button>
    }
  </ng-container>
</ui-modal>
