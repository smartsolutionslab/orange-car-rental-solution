<div class="page-header">
  <h1>{{ 'vehicles.title' | translate }}</h1>
  <p class="subtitle">{{ 'vehicles.subtitle' | translate }}</p>
</div>

<div class="dashboard-grid">
  <ui-stat-card
    [label]="'vehicles.stats.total' | translate"
    [value]="totalVehicles()"
    [loading]="loading()"
    iconName="car-filled"
  />
  <ui-stat-card
    [label]="'vehicles.stats.available' | translate"
    [value]="availableVehicles()"
    [loading]="loading()"
    variant="success"
  />
  <ui-stat-card
    [label]="'vehicles.stats.maintenance' | translate"
    [value]="maintenanceVehicles()"
    [loading]="loading()"
    variant="warning"
  />
  <ui-stat-card
    [label]="'vehicles.stats.rented' | translate"
    [value]="rentedVehicles()"
    [loading]="loading()"
    variant="info"
  />
</div>

<div class="content-section">
  <div class="section-header">
    <h2>{{ 'vehicles.overview' | translate }}</h2>
    <button class="btn-primary" disabled>
      <lib-icon name="plus-filled" variant="filled" size="md" aria-hidden="true" />
      {{ 'vehicles.addNew' | translate }}
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="statusFilter">{{ 'common.labels.status' | translate }}</label>
      <ui-select-vehicle-status
        id="statusFilter"
        [ngModel]="searchStatus()"
        (ngModelChange)="searchStatus.set($event); applyFilters()"
        [placeholder]="'vehicles.filters.allStatuses' | translate"
      />
    </div>

    <div class="filter-group">
      <label for="locationFilter">{{ 'common.labels.location' | translate }}</label>
      <ui-select-location
        id="locationFilter"
        [ngModel]="searchLocation()"
        (ngModelChange)="searchLocation.set($event); applyFilters()"
        [placeholder]="'vehicles.filters.allLocations' | translate"
      />
    </div>

    <div class="filter-group">
      <label for="categoryFilter">{{ 'common.labels.category' | translate }}</label>
      <ui-select-category
        id="categoryFilter"
        [ngModel]="searchCategory()"
        (ngModelChange)="searchCategory.set($event); applyFilters()"
        [placeholder]="'vehicles.filters.allCategories' | translate"
      />
    </div>

    <button class="btn-secondary" (click)="clearFilters()">
      {{ 'common.actions.resetFilters' | translate }}
    </button>
  </div>

  <!-- Error State -->
  @if (error()) {
    <ui-error-state
      [message]="error()!"
      [showRetry]="true"
      (retry)="loadVehicles()"
    ></ui-error-state>
  }

  <!-- Vehicles Data Table -->
  @if (!error()) {
    <ocr-data-table
      [data]="vehicles()"
      [loading]="loading()"
      [loadingMessage]="'vehicles.loading' | translate"
      [rowClickable]="true"
      (rowClick)="viewDetails($event.item)"
      emptyIcon="car"
      [emptyTitle]="'vehicles.noResults.title' | translate"
      [emptyDescription]="'vehicles.noResults.description' | translate"
      [trackByFn]="trackByVehicleId"
    >
      <!-- License Plate Column -->
      <ng-template ocrDataTableColumn="licensePlate" [header]="'vehicles.table.licensePlate' | translate" let-vehicle>
        @if (vehicle.licensePlate) {
          <span class="license-plate">{{ vehicle.licensePlate }}</span>
        } @else {
          <span class="text-muted">-</span>
        }
      </ng-template>

      <!-- Vehicle Column -->
      <ng-template ocrDataTableColumn="vehicle" [header]="'vehicles.table.vehicle' | translate" let-vehicle>
        {{ vehicle.manufacturer }} {{ vehicle.model }} ({{ vehicle.year }})
      </ng-template>

      <!-- Category Column -->
      <ng-template ocrDataTableColumn="categoryCode" [header]="'vehicles.table.category' | translate" let-vehicle>
        {{ vehicle.categoryCode }}
      </ng-template>

      <!-- Location Column -->
      <ng-template ocrDataTableColumn="locationCode" [header]="'vehicles.table.location' | translate" [hideOnMobile]="true" let-vehicle>
        {{ vehicle.locationCode }}
      </ng-template>

      <!-- Daily Rate Column -->
      <ng-template ocrDataTableColumn="dailyRateGross" [header]="'vehicles.table.dailyRate' | translate" [hideOnMobile]="true" let-vehicle>
        {{ vehicle.dailyRateGross.toFixed(2) }} {{ vehicle.currency }}
      </ng-template>

      <!-- Status Column -->
      <ng-template ocrDataTableColumn="status" [header]="'vehicles.table.status' | translate" let-vehicle>
        <ui-status-badge type="vehicle" [status]="vehicle.status"></ui-status-badge>
      </ng-template>

      <!-- Actions Column -->
      <ng-template ocrDataTableColumn="actions" [header]="'common.labels.actions' | translate" let-vehicle>
        <button
          class="btn-icon"
          (click)="viewDetails(vehicle); $event.stopPropagation()"
          [title]="'common.actions.viewDetails' | translate"
          [attr.aria-label]="'vehicles.ariaLabels.viewDetails' | translate"
        >
          <lib-icon name="eye-filled" variant="filled" size="sm" aria-hidden="true" />
        </button>
      </ng-template>
    </ocr-data-table>
  }
</div>

<!-- Vehicle Details Modal -->
<ui-modal
  [isOpen]="showDetails() && !!selectedVehicle()"
  [title]="'vehicles.details.title' | translate"
  size="lg"
  (close)="closeDetails()"
>
  <ng-container modal-body>
    @if (selectedVehicle()) {
      <!-- Vehicle Information -->
      <div class="info-section">
        <h3>{{ 'vehicles.details.info' | translate }}</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>{{ 'vehicles.details.vehicleId' | translate }}</label>
            <p>
              <span class="id-badge">{{ selectedVehicle()!.id }}</span>
            </p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.table.licensePlate' | translate }}</label>
            <p>
              @if (selectedVehicle()!.licensePlate) {
                <span class="license-plate">{{ selectedVehicle()!.licensePlate }}</span>
              } @else {
                <span class="text-muted">{{ 'vehicles.details.notAssigned' | translate }}</span>
              }
            </p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.manufacturerModel' | translate }}</label>
            <p>{{ selectedVehicle()!.manufacturer }} {{ selectedVehicle()!.model }}</p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.year' | translate }}</label>
            <p>{{ selectedVehicle()!.year }}</p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.table.category' | translate }}</label>
            <p>{{ selectedVehicle()!.categoryCode }} - {{ selectedVehicle()!.categoryName }}</p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.table.status' | translate }}</label>
            <p>
              <ui-status-badge
                type="vehicle"
                [status]="selectedVehicle()!.status"
              ></ui-status-badge>
            </p>
          </div>
        </div>
      </div>

      <!-- Location & Pricing -->
      <div class="info-section">
        <h3>{{ 'vehicles.details.locationPricing' | translate }}</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>{{ 'vehicles.table.location' | translate }}</label>
            <p>{{ selectedVehicle()!.locationCode }} - {{ selectedVehicle()!.city }}</p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.dailyRateNet' | translate }}</label>
            <p>
              {{ selectedVehicle()!.dailyRateNet.toFixed(2) }} {{ selectedVehicle()!.currency }}
            </p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.vat' | translate }}</label>
            <p>
              {{ selectedVehicle()!.dailyRateVat.toFixed(2) }} {{ selectedVehicle()!.currency }}
            </p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.dailyRateGross' | translate }}</label>
            <p>
              <strong
                >{{ selectedVehicle()!.dailyRateGross.toFixed(2) }}
                {{ selectedVehicle()!.currency }}</strong
              >
            </p>
          </div>
        </div>
      </div>

      <!-- Features -->
      <div class="info-section">
        <h3>{{ 'vehicles.details.features' | translate }}</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>{{ 'vehicles.details.transmission' | translate }}</label>
            <p>
              {{
                selectedVehicle()!.transmissionType === 'Automatic'
                  ? ('vehicles.transmission.automatic' | translate)
                  : ('vehicles.transmission.manual' | translate)
              }}
            </p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.fuelType' | translate }}</label>
            <p>{{ selectedVehicle()!.fuelType }}</p>
          </div>
          <div class="detail-item">
            <label>{{ 'vehicles.details.seats' | translate }}</label>
            <p>{{ selectedVehicle()!.seats }}</p>
          </div>
        </div>
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    <button class="btn-secondary" (click)="closeDetails()">
      {{ 'common.actions.close' | translate }}
    </button>
  </ng-container>
</ui-modal>
