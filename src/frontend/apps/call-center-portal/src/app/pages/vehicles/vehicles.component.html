<div class="page-header">
  <h1>Fahrzeugverwaltung</h1>
  <p class="subtitle">Verwalten Sie Ihre Fahrzeugflotte</p>
</div>

<div class="dashboard-grid">
  <ui-stat-card
    label="Gesamte Fahrzeuge"
    [value]="totalVehicles"
    [loading]="loading()"
    iconPath="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"
  />
  <ui-stat-card
    label="Verfügbar"
    [value]="availableVehicles"
    [loading]="loading()"
    variant="success"
  />
  <ui-stat-card
    label="In Wartung"
    [value]="maintenanceVehicles"
    [loading]="loading()"
    variant="warning"
  />
  <ui-stat-card
    label="Vermietet"
    [value]="rentedVehicles"
    [loading]="loading()"
    variant="info"
  />
</div>

<div class="content-section">
  <div class="section-header">
    <h2>Fahrzeugübersicht</h2>
    <button class="btn-primary" disabled>
      <lib-icon name="plus-filled" variant="filled" size="md" />
      Neues Fahrzeug
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="statusFilter">Status</label>
      <ui-select-vehicle-status
        id="statusFilter"
        [ngModel]="searchStatus()"
        (ngModelChange)="searchStatus.set($event); applyFilters()"
        placeholder="Alle Status"
      />
    </div>

    <div class="filter-group">
      <label for="locationFilter">Standort</label>
      <ui-select-location
        id="locationFilter"
        [ngModel]="searchLocation()"
        (ngModelChange)="searchLocation.set($event); applyFilters()"
        placeholder="Alle Standorte"
      />
    </div>

    <div class="filter-group">
      <label for="categoryFilter">Kategorie</label>
      <ui-select-category
        id="categoryFilter"
        [ngModel]="searchCategory()"
        (ngModelChange)="searchCategory.set($event); applyFilters()"
        placeholder="Alle Kategorien"
      />
    </div>

    <button class="btn-secondary" (click)="clearFilters()">Filter zurücksetzen</button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <ui-loading-state message="Lade Fahrzeuge..."></ui-loading-state>
  }

  <!-- Error State -->
  @if (error()) {
    <ui-error-state [message]="error()!" [showRetry]="true" (retry)="loadVehicles()"></ui-error-state>
  }

  <!-- Vehicles Table -->
  @if (!loading() && !error() && vehicles().length > 0) {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Kennzeichen</th>
            <th>Fahrzeug</th>
            <th>Kategorie</th>
            <th>Standort</th>
            <th>Tagespreis</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          @for (vehicle of vehicles(); track vehicle.id) {
            <tr>
              <td>
                @if (vehicle.licensePlate) {
                  <span class="license-plate">{{ vehicle.licensePlate }}</span>
                } @else {
                  <span class="text-muted">-</span>
                }
              </td>
              <td>{{ vehicle.manufacturer }} {{ vehicle.model }} ({{ vehicle.year }})</td>
              <td>{{ vehicle.categoryCode }}</td>
              <td>{{ vehicle.locationCode }}</td>
              <td>{{ vehicle.dailyRateGross.toFixed(2) }} {{ vehicle.currency }}</td>
              <td><ui-status-badge type="vehicle" [status]="vehicle.status"></ui-status-badge></td>
              <td>
                <button class="btn-icon" (click)="viewDetails(vehicle)" title="Details anzeigen">
                  <lib-icon name="eye-filled" variant="filled" size="sm" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- No Results -->
  @if (!loading() && !error() && vehicles().length === 0) {
    <ui-empty-state
      icon="car"
      title="Keine Fahrzeuge gefunden"
      description="Es wurden keine Fahrzeuge gefunden, die den Filterkriterien entsprechen."
      [showAction]="true"
      actionLabel="Filter zurücksetzen"
      (action)="clearFilters()"
    ></ui-empty-state>
  }
</div>

<!-- Vehicle Details Modal -->
<ui-modal [isOpen]="showDetails() && !!selectedVehicle()" title="Fahrzeugdetails" size="lg" (close)="closeDetails()">
  <ng-container modal-body>
    @if (selectedVehicle()) {
      <!-- Vehicle Information -->
      <div class="info-section">
        <h3>Fahrzeuginformationen</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Fahrzeug-ID</label>
            <p><span class="id-badge">{{ selectedVehicle()!.id }}</span></p>
          </div>
          <div class="detail-item">
            <label>Kennzeichen</label>
            <p>
              @if (selectedVehicle()!.licensePlate) {
                <span class="license-plate">{{ selectedVehicle()!.licensePlate }}</span>
              } @else {
                <span class="text-muted">Nicht zugewiesen</span>
              }
            </p>
          </div>
          <div class="detail-item">
            <label>Hersteller & Modell</label>
            <p>{{ selectedVehicle()!.manufacturer }} {{ selectedVehicle()!.model }}</p>
          </div>
          <div class="detail-item">
            <label>Baujahr</label>
            <p>{{ selectedVehicle()!.year }}</p>
          </div>
          <div class="detail-item">
            <label>Kategorie</label>
            <p>{{ selectedVehicle()!.categoryCode }} - {{ selectedVehicle()!.categoryName }}</p>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <p><ui-status-badge type="vehicle" [status]="selectedVehicle()!.status"></ui-status-badge></p>
          </div>
        </div>
      </div>

      <!-- Location & Pricing -->
      <div class="info-section">
        <h3>Standort & Preise</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Standort</label>
            <p>{{ selectedVehicle()!.locationCode }} - {{ selectedVehicle()!.city }}</p>
          </div>
          <div class="detail-item">
            <label>Tagespreis (Netto)</label>
            <p>{{ selectedVehicle()!.dailyRateNet.toFixed(2) }} {{ selectedVehicle()!.currency }}</p>
          </div>
          <div class="detail-item">
            <label>MwSt (19%)</label>
            <p>{{ selectedVehicle()!.dailyRateVat.toFixed(2) }} {{ selectedVehicle()!.currency }}</p>
          </div>
          <div class="detail-item">
            <label>Tagespreis (Brutto)</label>
            <p><strong>{{ selectedVehicle()!.dailyRateGross.toFixed(2) }} {{ selectedVehicle()!.currency }}</strong></p>
          </div>
        </div>
      </div>

      <!-- Features -->
      <div class="info-section">
        <h3>Ausstattung</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Getriebe</label>
            <p>{{ selectedVehicle()!.transmissionType === 'Automatic' ? 'Automatik' : 'Manuell' }}</p>
          </div>
          <div class="detail-item">
            <label>Kraftstoff</label>
            <p>{{ selectedVehicle()!.fuelType }}</p>
          </div>
          <div class="detail-item">
            <label>Sitzplätze</label>
            <p>{{ selectedVehicle()!.seats }}</p>
          </div>
        </div>
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    <button class="btn-secondary" (click)="closeDetails()">Schließen</button>
  </ng-container>
</ui-modal>
