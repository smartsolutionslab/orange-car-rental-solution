<div class="page-header">
  <h1>{{ 'reservations.title' | translate }}</h1>
  <p class="subtitle">{{ 'reservations.subtitle' | translate }}</p>
</div>

<!-- Statistics Dashboard -->
<div class="dashboard-grid">
  <ui-stat-card
    [label]="'reservations.stats.todayBookings' | translate"
    [value]="todayReservations()"
    [loading]="loading()"
    iconName="calendar-filled"
  />
  <ui-stat-card
    [label]="'reservations.stats.activeBookings' | translate"
    [value]="activeReservations()"
    [loading]="loading()"
    variant="success"
  />
  <ui-stat-card
    [label]="'reservations.stats.pending' | translate"
    [value]="pendingReservations()"
    [loading]="loading()"
    variant="warning"
  />
  <ui-stat-card
    [label]="'reservations.stats.total' | translate"
    [value]="totalCount()"
    [loading]="loading()"
    variant="info"
    iconName="clock-filled"
  />
</div>

<!-- Success Message -->
@if (successMessage()) {
  <ui-success-alert [message]="successMessage()!"></ui-success-alert>
}

<!-- Error Message -->
@if (error()) {
  <ui-error-alert [message]="error()!"></ui-error-alert>
}

<div class="content-section">
  <div class="section-header">
    <h2>{{ 'reservations.overview' | translate }}</h2>
    <button class="btn-primary" disabled>
      <lib-icon name="plus-filled" variant="filled" size="md" aria-hidden="true" />
      {{ 'common.actions.newBooking' | translate }}
    </button>
  </div>

  <!-- Advanced Filters Section -->
  <div class="filters-panel">
    <div class="filters-header">
      <h3>{{ 'reservations.filters.title' | translate }}</h3>
      <div class="filters-actions">
        @if (activeFiltersCount() > 0) {
          <span class="active-filters-badge">{{
            'common.messages.activeFilters' | translate: { count: activeFiltersCount() }
          }}</span>
        }
        <button class="btn-secondary btn-sm" (click)="clearFilters()">
          <lib-icon name="x-filled" variant="filled" size="sm" aria-hidden="true" />
          {{ 'common.actions.reset' | translate }}
        </button>
      </div>
    </div>

    <!-- Filter Grid -->
    <div class="filters-grid">
      <!-- Status Filter -->
      <div class="filter-group">
        <label for="statusFilter">{{ 'reservations.filters.status' | translate }}</label>
        <ui-select-reservation-status
          id="statusFilter"
          [(ngModel)]="searchStatus"
          [placeholder]="'reservations.filters.allStatus' | translate"
        />
      </div>

      <!-- Customer ID Filter -->
      <div class="filter-group">
        <ocr-input
          [label]="'reservations.filters.customerId' | translate"
          type="text"
          [(ngModel)]="searchCustomerId"
          [placeholder]="'reservations.filters.customerIdPlaceholder' | translate"
          leadingIcon="user"
        />
      </div>

      <!-- Pickup Date From -->
      <div class="filter-group">
        <ocr-input
          [label]="'reservations.filters.pickupFrom' | translate"
          type="date"
          [(ngModel)]="searchPickupDateFrom"
        />
      </div>

      <!-- Pickup Date To -->
      <div class="filter-group">
        <ocr-input
          [label]="'reservations.filters.pickupTo' | translate"
          type="date"
          [(ngModel)]="searchPickupDateTo"
        />
      </div>

      <!-- Location Filter -->
      <div class="filter-group">
        <label for="locationFilter">{{ 'reservations.filters.location' | translate }}</label>
        <ui-select-location
          id="locationFilter"
          [(ngModel)]="searchLocation"
          [placeholder]="'reservations.filters.allLocations' | translate"
        />
      </div>

      <!-- Min Price Filter -->
      <div class="filter-group">
        <ocr-input
          [label]="'reservations.filters.minPrice' | translate"
          type="number"
          [(ngModel)]="searchMinPrice"
          placeholder="0"
          min="0"
          leadingIcon="currency-euro"
        />
      </div>

      <!-- Max Price Filter -->
      <div class="filter-group">
        <ocr-input
          [label]="'reservations.filters.maxPrice' | translate"
          type="number"
          [(ngModel)]="searchMaxPrice"
          placeholder="1000"
          min="0"
          leadingIcon="currency-euro"
        />
      </div>

      <!-- Apply Filters Button -->
      <div class="filter-group filter-actions">
        <button class="btn-primary btn-block" (click)="applyFilters()" [disabled]="loading()">
          <lib-icon name="filter-filled" variant="filled" [customSize]="18" aria-hidden="true" />
          {{ 'common.actions.applyFilters' | translate }}
        </button>
      </div>
    </div>

    <!-- Sorting and Grouping Controls -->
    <div class="controls-row">
      <!-- Sorting -->
      <div class="control-group">
        <div class="sort-controls">
          <ocr-select
            [label]="'common.sorting.label' | translate"
            [options]="sortOptions()"
            [(ngModel)]="sortBy"
            (selectChange)="applyFilters()"
            leadingIcon="arrow-up-down"
          />
          <button
            class="btn-icon"
            (click)="changeSortBy(sortBy())"
            [title]="
              sortOrder() === 'asc'
                ? ('common.sorting.ascending' | translate)
                : ('common.sorting.descending' | translate)
            "
            [attr.aria-label]="
              sortOrder() === 'asc'
                ? ('common.sorting.ascending' | translate)
                : ('common.sorting.descending' | translate)
            "
          >
            @if (sortOrder() === 'asc') {
              <lib-icon
                name="chevron-up-filled"
                variant="filled"
                [customSize]="20"
                aria-hidden="true"
              />
            } @else {
              <lib-icon
                name="chevron-down-filled"
                variant="filled"
                [customSize]="20"
                aria-hidden="true"
              />
            }
          </button>
        </div>
      </div>

      <!-- Grouping -->
      <div class="control-group">
        <ocr-select
          [label]="'common.grouping.label' | translate"
          [options]="groupOptions()"
          [(ngModel)]="groupBy"
          (selectChange)="changeGroupBy(groupBy())"
          leadingIcon="layers"
        />
      </div>

      <!-- Page Size -->
      <div class="control-group">
        <label>{{ 'common.pagination.entriesPerPage' | translate }}</label>
        <ui-select-page-size [(ngModel)]="pageSize" (ngModelChange)="applyFilters()" />
      </div>
    </div>

    <!-- Result Count -->
    <div class="results-info">
      <p>
        {{
          'reservations.results.showing'
            | translate
              : {
                  from: (currentPage() - 1) * pageSize() + 1,
                  to: Math.min(currentPage() * pageSize(), totalCount()),
                  total: totalCount(),
                }
        }}
      </p>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <ui-loading-state [message]="'reservations.loading' | translate"></ui-loading-state>
  }

  <!-- Reservations Table/List -->
  @if (!loading() && reservations().length > 0) {
    <!-- Grouped Display -->
    @if (groupBy() !== 'none') {
      <div class="grouped-reservations">
        @for (groupKey of groupKeys(); track groupKey) {
          <div class="group-section">
            <div class="group-header">
              <h3>{{ groupKey }}</h3>
              <span class="group-count"
                >{{ groupedReservations()[groupKey].length }}
                {{ 'reservations.groups.bookings' | translate }}</span
              >
            </div>
            <div class="reservations-table">
              <table>
                <thead>
                  <tr>
                    <th scope="col">{{ 'reservations.table.reservationId' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.customer' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.pickupDate' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.returnDate' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.location' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.price' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.status' | translate }}</th>
                    <th scope="col">{{ 'reservations.table.actions' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (
                    reservation of groupedReservations()[groupKey];
                    track reservation.reservationId
                  ) {
                    <tr>
                      <td>
                        <span class="reservation-id" [title]="reservation.reservationId">
                          {{ reservation.reservationId.substring(0, 8) }}...
                        </span>
                      </td>
                      <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                      <td>{{ formatDate(reservation.pickupDate) }}</td>
                      <td>{{ formatDate(reservation.returnDate) }}</td>
                      <td>{{ reservation.pickupLocationCode }}</td>
                      <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                      <td>
                        <ui-status-badge
                          type="reservation"
                          [status]="reservation.status"
                        ></ui-status-badge>
                      </td>
                      <td class="actions-cell">
                        <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">
                          {{ 'common.actions.details' | translate }}
                        </button>
                        @if (canConfirm(reservation)) {
                          <button
                            class="btn-sm btn-success"
                            (click)="confirmReservation(reservation)"
                          >
                            {{ 'common.actions.confirm' | translate }}
                          </button>
                        }
                        @if (canCancel(reservation)) {
                          <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">
                            {{ 'reservations.cancel.button' | translate }}
                          </button>
                        }
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>
    }

    <!-- Ungrouped Display -->
    @else {
      <div class="reservations-table">
        <table>
          <thead>
            <tr>
              <th scope="col">{{ 'reservations.table.reservationId' | translate }}</th>
              <th scope="col">{{ 'reservations.table.customer' | translate }}</th>
              <th scope="col">{{ 'reservations.table.pickupDate' | translate }}</th>
              <th scope="col">{{ 'reservations.table.returnDate' | translate }}</th>
              <th scope="col">{{ 'reservations.table.location' | translate }}</th>
              <th scope="col">{{ 'reservations.table.price' | translate }}</th>
              <th scope="col">{{ 'reservations.table.status' | translate }}</th>
              <th scope="col">{{ 'reservations.table.actions' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (reservation of reservations(); track reservation.reservationId) {
              <tr>
                <td>
                  <span class="reservation-id" [title]="reservation.reservationId">
                    {{ reservation.reservationId.substring(0, 8) }}...
                  </span>
                </td>
                <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                <td>{{ formatDate(reservation.pickupDate) }}</td>
                <td>{{ formatDate(reservation.returnDate) }}</td>
                <td>{{ reservation.pickupLocationCode }}</td>
                <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                <td>
                  <ui-status-badge
                    type="reservation"
                    [status]="reservation.status"
                  ></ui-status-badge>
                </td>
                <td class="actions-cell">
                  <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">
                    {{ 'common.actions.details' | translate }}
                  </button>
                  @if (canConfirm(reservation)) {
                    <button class="btn-sm btn-success" (click)="confirmReservation(reservation)">
                      {{ 'common.actions.confirm' | translate }}
                    </button>
                  }
                  @if (canCancel(reservation)) {
                    <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">
                      {{ 'reservations.cancel.button' | translate }}
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Pagination -->
    <ui-pagination
      [currentPage]="currentPage()"
      [totalPages]="totalPages()"
      [totalItems]="totalCount()"
      [pageSize]="pageSize()"
      [showItemRange]="true"
      [itemLabel]="'reservations.itemLabel' | translate"
      [itemLabelPlural]="'reservations.itemLabelPlural' | translate"
      (pageChange)="goToPage($event)"
    />
  }

  <!-- Empty State -->
  @if (!loading() && reservations().length === 0) {
    <ui-empty-state
      icon="reservation"
      [title]="'reservations.empty.title' | translate"
      [description]="'reservations.empty.description' | translate"
      [showAction]="activeFiltersCount() > 0"
      [actionLabel]="'reservations.empty.resetFilters' | translate"
      (action)="clearFilters()"
    ></ui-empty-state>
  }
</div>

<!-- Details Modal -->
<ui-modal
  [isOpen]="showDetails() && !!selectedReservation()"
  [title]="'reservations.details.title' | translate"
  size="lg"
  (close)="closeDetails()"
>
  <ng-container modal-body>
    @if (selectedReservation()) {
      <div class="detail-grid">
        <div class="detail-item">
          <label>{{ 'common.labels.reservationId' | translate }}</label>
          <p>{{ selectedReservation()!.reservationId }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'common.labels.customerId' | translate }}</label>
          <p>{{ selectedReservation()!.customerId }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.vehicleId' | translate }}</label>
          <p>{{ selectedReservation()!.vehicleId }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'common.labels.status' | translate }}</label>
          <p>
            <ui-status-badge
              type="reservation"
              [status]="selectedReservation()!.status"
            ></ui-status-badge>
          </p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.pickupDate' | translate }}</label>
          <p>{{ formatDate(selectedReservation()!.pickupDate) }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.returnDate' | translate }}</label>
          <p>{{ formatDate(selectedReservation()!.returnDate) }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.pickupLocation' | translate }}</label>
          <p>{{ selectedReservation()!.pickupLocationCode }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.returnLocation' | translate }}</label>
          <p>{{ selectedReservation()!.dropoffLocationCode }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.rentalDays' | translate }}</label>
          <p>{{ selectedReservation()!.rentalDays }}</p>
        </div>
        <div class="detail-item">
          <label>{{ 'reservations.details.createdAt' | translate }}</label>
          <p>{{ formatDate(selectedReservation()!.createdAt) }}</p>
        </div>
      </div>

      <div class="price-section">
        <h3>{{ 'reservations.pricing.title' | translate }}</h3>
        <div class="price-breakdown">
          <div class="price-row">
            <span>{{ 'reservations.pricing.netAmount' | translate }}:</span>
            <span>{{ formatPrice(selectedReservation()!.totalPriceNet) }}</span>
          </div>
          <div class="price-row">
            <span>{{ 'reservations.pricing.vat' | translate }}:</span>
            <span>{{ formatPrice(selectedReservation()!.totalPriceVat) }}</span>
          </div>
          <div class="price-row total">
            <span
              ><strong>{{ 'reservations.pricing.grossAmount' | translate }}:</strong></span
            >
            <span
              ><strong>{{ formatPrice(selectedReservation()!.totalPriceGross) }}</strong></span
            >
          </div>
        </div>
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    @if (selectedReservation() && canConfirm(selectedReservation()!)) {
      <button
        class="btn-success"
        (click)="confirmReservation(selectedReservation()!)"
        [disabled]="actionInProgress()"
      >
        {{ 'reservations.confirm.button' | translate }}
      </button>
    }
    @if (selectedReservation() && canCancel(selectedReservation()!)) {
      <button
        class="btn-danger"
        (click)="showCancelDialog(selectedReservation()!)"
        [disabled]="actionInProgress()"
      >
        {{ 'reservations.cancel.button' | translate }}
      </button>
    }
    <button class="btn-secondary" (click)="closeDetails()">
      {{ 'common.actions.close' | translate }}
    </button>
  </ng-container>
</ui-modal>

<!-- Cancel Modal -->
<ui-modal
  [isOpen]="showCancelModal() && !!selectedReservation()"
  [title]="'reservations.cancel.title' | translate"
  size="sm"
  (close)="closeCancelModal()"
>
  <ng-container modal-body>
    @if (selectedReservation()) {
      <p>{{ 'reservations.cancel.message' | translate }}</p>
      <p>
        <strong>{{ 'common.labels.reservationId' | translate }}:</strong>
        {{ selectedReservation()!.reservationId.substring(0, 8) }}...
      </p>

      <ocr-textarea
        [label]="'reservations.cancel.reason' | translate"
        [(ngModel)]="cancelReason"
        [rows]="4"
        [placeholder]="'reservations.cancel.reasonPlaceholder' | translate"
        [required]="true"
      />

      @if (error()) {
        <ui-error-state variant="inline" [message]="error()!"></ui-error-state>
      }
    }
  </ng-container>
  <ng-container modal-footer>
    <button class="btn-secondary" (click)="closeCancelModal()">
      {{ 'common.actions.cancel' | translate }}
    </button>
    <button
      class="btn-danger"
      (click)="cancelReservation()"
      [disabled]="!cancelReason() || actionInProgress()"
    >
      {{
        actionInProgress()
          ? ('reservations.cancel.inProgress' | translate)
          : ('reservations.cancel.execute' | translate)
      }}
    </button>
  </ng-container>
</ui-modal>

<!-- Confirm Modal -->
<ui-modal
  [isOpen]="showConfirmModal() && !!selectedReservation()"
  [title]="'reservations.confirm.title' | translate"
  size="sm"
  (close)="closeConfirmModal()"
>
  <ng-container modal-body>
    @if (selectedReservation()) {
      <p>{{ 'reservations.confirm.message' | translate }}</p>
      <p>
        <strong>{{ 'common.labels.reservationId' | translate }}:</strong>
        {{ selectedReservation()!.reservationId.substring(0, 8) }}...
      </p>
      <p>
        <strong>{{ 'reservations.table.customer' | translate }}:</strong>
        {{ selectedReservation()!.customerId.substring(0, 8) }}...
      </p>
      <p>
        <strong>{{ 'reservations.details.pickupDate' | translate }}:</strong>
        {{ formatDate(selectedReservation()!.pickupDate) }}
      </p>
      <p>
        <strong>{{ 'reservations.pricing.grossAmount' | translate }}:</strong>
        {{ formatPrice(selectedReservation()!.totalPriceGross) }}
      </p>

      @if (error()) {
        <ui-error-state variant="inline" [message]="error()!"></ui-error-state>
      }
    }
  </ng-container>
  <ng-container modal-footer>
    <button class="btn-secondary" (click)="closeConfirmModal()">
      {{ 'common.actions.cancel' | translate }}
    </button>
    <button class="btn-success" (click)="executeConfirmation()" [disabled]="actionInProgress()">
      {{
        actionInProgress()
          ? ('reservations.confirm.inProgress' | translate)
          : ('reservations.confirm.execute' | translate)
      }}
    </button>
  </ng-container>
</ui-modal>
