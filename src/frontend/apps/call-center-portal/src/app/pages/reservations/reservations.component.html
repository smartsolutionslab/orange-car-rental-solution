<div class="page-header">
  <h1>Buchungsverwaltung</h1>
  <p class="subtitle">Verwalten Sie alle Reservierungen und Buchungen</p>
</div>


<!-- Statistics Dashboard -->
<div class="dashboard-grid">
  <ui-stat-card
    label="Heutige Buchungen"
    [value]="todayReservations()"
    [loading]="loading()"
    iconPath="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM5 7V5h14v2H5zm2 4h10v2H7zm0 4h7v2H7z"
  />
  <ui-stat-card
    label="Aktive Buchungen"
    [value]="activeReservations()"
    [loading]="loading()"
    variant="success"
  />
  <ui-stat-card
    label="Anstehend"
    [value]="pendingReservations()"
    [loading]="loading()"
    variant="warning"
  />
  <ui-stat-card
    label="Gesamt"
    [value]="totalCount()"
    [loading]="loading()"
    variant="info"
    iconPath="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"
  />
</div>

<!-- Success Message -->
@if (successMessage()) {
  <ui-success-alert [message]="successMessage()!"></ui-success-alert>
}

<!-- Error Message -->
@if (error()) {
  <div class="error-message">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
    </svg>
    {{ error() }}
  </div>
}

<div class="content-section">
  <div class="section-header">
    <h2>Reservierungsübersicht</h2>
    <button class="btn-primary" disabled>
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
      Neue Buchung
    </button>
  </div>

  <!-- Advanced Filters Section -->
  <div class="filters-panel">
    <div class="filters-header">
      <h3>Filter & Sortierung</h3>
      <div class="filters-actions">
        @if (activeFiltersCount() > 0) {
          <span class="active-filters-badge">{{ activeFiltersCount() }} aktive Filter</span>
        }
        <button class="btn-secondary btn-sm" (click)="clearFilters()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
          Zurücksetzen
        </button>
      </div>
    </div>

    <!-- Filter Grid -->
    <div class="filters-grid">
      <!-- Status Filter -->
      <div class="filter-group">
        <label for="statusFilter">Status</label>
        <ui-select-reservation-status
          id="statusFilter"
          [(ngModel)]="searchStatus"
          placeholder="Alle Status"
        />
      </div>

      <!-- Customer ID Filter -->
      <div class="filter-group">
        <label for="customerFilter">Kunden-ID</label>
        <input
          type="text"
          id="customerFilter"
          [(ngModel)]="searchCustomerId"
          placeholder="Kunden-ID eingeben..."
        />
      </div>

      <!-- Pickup Date From -->
      <div class="filter-group">
        <label for="dateFromFilter">Abholung von</label>
        <input
          type="date"
          id="dateFromFilter"
          [(ngModel)]="searchPickupDateFrom"
        />
      </div>

      <!-- Pickup Date To -->
      <div class="filter-group">
        <label for="dateToFilter">Abholung bis</label>
        <input
          type="date"
          id="dateToFilter"
          [(ngModel)]="searchPickupDateTo"
        />
      </div>

      <!-- Location Filter -->
      <div class="filter-group">
        <label for="locationFilter">Standort</label>
        <ui-select-location
          id="locationFilter"
          [(ngModel)]="searchLocation"
          placeholder="Alle Standorte"
        />
      </div>

      <!-- Min Price Filter -->
      <div class="filter-group">
        <label for="minPriceFilter">Min. Preis (€)</label>
        <input
          type="number"
          id="minPriceFilter"
          [(ngModel)]="searchMinPrice"
          placeholder="0"
          min="0"
        />
      </div>

      <!-- Max Price Filter -->
      <div class="filter-group">
        <label for="maxPriceFilter">Max. Preis (€)</label>
        <input
          type="number"
          id="maxPriceFilter"
          [(ngModel)]="searchMaxPrice"
          placeholder="1000"
          min="0"
        />
      </div>

      <!-- Apply Filters Button -->
      <div class="filter-group filter-actions">
        <button class="btn-primary btn-block" (click)="applyFilters()" [disabled]="loading()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
          </svg>
          Filter anwenden
        </button>
      </div>
    </div>

    <!-- Sorting and Grouping Controls -->
    <div class="controls-row">
      <!-- Sorting -->
      <div class="control-group">
        <label>Sortierung</label>
        <div class="sort-controls">
          <select [(ngModel)]="sortBy" (change)="applyFilters()">
            @for (option of sortOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
          <button
            class="btn-icon"
            (click)="changeSortBy(sortBy())"
            [title]="sortOrder() === 'asc' ? 'Aufsteigend' : 'Absteigend'"
          >
            @if (sortOrder() === 'asc') {
              <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M7 14l5-5 5 5z"/>
              </svg>
            } @else {
              <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            }
          </button>
        </div>
      </div>

      <!-- Grouping -->
      <div class="control-group">
        <label>Gruppierung</label>
        <select [(ngModel)]="groupBy" (change)="changeGroupBy(groupBy())">
          @for (option of groupOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Page Size -->
      <div class="control-group">
        <label>Einträge pro Seite</label>
        <ui-select-page-size
          [(ngModel)]="pageSize"
          (ngModelChange)="applyFilters()"
        />
      </div>
    </div>

    <!-- Result Count -->
    <div class="results-info">
      <p>
        Zeige {{ (currentPage() - 1) * pageSize() + 1 }} -
        {{ Math.min(currentPage() * pageSize(), totalCount()) }}
        von {{ totalCount() }} Reservierungen
      </p>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <ui-loading-state message="Reservierungen werden geladen..."></ui-loading-state>
  }

  <!-- Reservations Table/List -->
  @if (!loading() && reservations().length > 0) {
    <!-- Grouped Display -->
    @if (groupBy() !== 'none') {
      <div class="grouped-reservations">
        @for (groupKey of groupKeys(); track groupKey) {
          <div class="group-section">
            <div class="group-header">
              <h3>{{ groupKey }}</h3>
              <span class="group-count">{{ groupedReservations()[groupKey].length }} Buchungen</span>
            </div>
            <div class="reservations-table">
              <table>
                <thead>
                  <tr>
                    <th>Reservierungs-ID</th>
                    <th>Kunde</th>
                    <th>Abholdatum</th>
                    <th>Rückgabedatum</th>
                    <th>Standort</th>
                    <th>Preis</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  @for (reservation of groupedReservations()[groupKey]; track reservation.reservationId) {
                    <tr>
                      <td>
                        <span class="reservation-id" [title]="reservation.reservationId">
                          {{ reservation.reservationId.substring(0, 8) }}...
                        </span>
                      </td>
                      <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                      <td>{{ formatDate(reservation.pickupDate) }}</td>
                      <td>{{ formatDate(reservation.returnDate) }}</td>
                      <td>{{ reservation.pickupLocationCode }}</td>
                      <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                      <td>
                        <ui-status-badge type="reservation" [status]="reservation.status"></ui-status-badge>
                      </td>
                      <td class="actions-cell">
                        <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">Details</button>
                        @if (canConfirm(reservation)) {
                          <button class="btn-sm btn-success" (click)="confirmReservation(reservation)">Bestätigen</button>
                        }
                        @if (canCancel(reservation)) {
                          <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">Stornieren</button>
                        }
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>
    }

    <!-- Ungrouped Display -->
    @else {
      <div class="reservations-table">
        <table>
          <thead>
            <tr>
              <th>Reservierungs-ID</th>
              <th>Kunde</th>
              <th>Abholdatum</th>
              <th>Rückgabedatum</th>
              <th>Standort</th>
              <th>Preis</th>
              <th>Status</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
            @for (reservation of reservations(); track reservation.reservationId) {
              <tr>
                <td>
                  <span class="reservation-id" [title]="reservation.reservationId">
                    {{ reservation.reservationId.substring(0, 8) }}...
                  </span>
                </td>
                <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                <td>{{ formatDate(reservation.pickupDate) }}</td>
                <td>{{ formatDate(reservation.returnDate) }}</td>
                <td>{{ reservation.pickupLocationCode }}</td>
                <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                <td>
                  <ui-status-badge type="reservation" [status]="reservation.status"></ui-status-badge>
                </td>
                <td class="actions-cell">
                  <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">Details</button>
                  @if (canConfirm(reservation)) {
                    <button class="btn-sm btn-success" (click)="confirmReservation(reservation)">Bestätigen</button>
                  }
                  @if (canCancel(reservation)) {
                    <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">Stornieren</button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }


    <!-- Pagination -->
    <ui-pagination
      [currentPage]="currentPage()"
      [totalPages]="totalPages()"
      [totalItems]="totalCount()"
      [pageSize]="pageSize()"
      [showItemRange]="true"
      itemLabel="Reservierung"
      itemLabelPlural="Reservierungen"
      (pageChange)="goToPage($event)"
    />
  }

  <!-- Empty State -->
  @if (!loading() && reservations().length === 0) {
    <ui-empty-state
      icon="reservation"
      title="Keine Reservierungen gefunden"
      description="Versuchen Sie, die Filter anzupassen, um weitere Ergebnisse zu sehen."
      [showAction]="activeFiltersCount() > 0"
      actionLabel="Filter zurücksetzen"
      (action)="clearFilters()"
    ></ui-empty-state>
  }
</div>

<!-- Details Modal -->
<ui-modal [isOpen]="showDetails() && !!selectedReservation()" title="Reservierungsdetails" size="lg" (close)="closeDetails()">
  <ng-container modal-body>
    @if (selectedReservation()) {
      <div class="detail-grid">
        <div class="detail-item">
          <label>Reservierungs-ID</label>
          <p>{{ selectedReservation()!.reservationId }}</p>
        </div>
        <div class="detail-item">
          <label>Kunden-ID</label>
          <p>{{ selectedReservation()!.customerId }}</p>
        </div>
        <div class="detail-item">
          <label>Fahrzeug-ID</label>
          <p>{{ selectedReservation()!.vehicleId }}</p>
        </div>
        <div class="detail-item">
          <label>Status</label>
          <p>
            <ui-status-badge type="reservation" [status]="selectedReservation()!.status"></ui-status-badge>
          </p>
        </div>
        <div class="detail-item">
          <label>Abholdatum</label>
          <p>{{ formatDate(selectedReservation()!.pickupDate) }}</p>
        </div>
        <div class="detail-item">
          <label>Rückgabedatum</label>
          <p>{{ formatDate(selectedReservation()!.returnDate) }}</p>
        </div>
        <div class="detail-item">
          <label>Abholort</label>
          <p>{{ selectedReservation()!.pickupLocationCode }}</p>
        </div>
        <div class="detail-item">
          <label>Rückgabeort</label>
          <p>{{ selectedReservation()!.dropoffLocationCode }}</p>
        </div>
        <div class="detail-item">
          <label>Miettage</label>
          <p>{{ selectedReservation()!.rentalDays }}</p>
        </div>
        <div class="detail-item">
          <label>Erstellt am</label>
          <p>{{ formatDate(selectedReservation()!.createdAt) }}</p>
        </div>
      </div>

      <div class="price-section">
        <h3>Preisübersicht</h3>
        <div class="price-breakdown">
          <div class="price-row">
            <span>Nettobetrag:</span>
            <span>{{ formatPrice(selectedReservation()!.totalPriceNet) }}</span>
          </div>
          <div class="price-row">
            <span>MwSt. (19%):</span>
            <span>{{ formatPrice(selectedReservation()!.totalPriceVat) }}</span>
          </div>
          <div class="price-row total">
            <span><strong>Gesamtbetrag:</strong></span>
            <span><strong>{{ formatPrice(selectedReservation()!.totalPriceGross) }}</strong></span>
          </div>
        </div>
      </div>
    }
  </ng-container>
  <ng-container modal-footer>
    @if (selectedReservation() && canConfirm(selectedReservation()!)) {
      <button class="btn-success" (click)="confirmReservation(selectedReservation()!)" [disabled]="actionInProgress()">
        Bestätigen
      </button>
    }
    @if (selectedReservation() && canCancel(selectedReservation()!)) {
      <button class="btn-danger" (click)="showCancelDialog(selectedReservation()!)" [disabled]="actionInProgress()">
        Stornieren
      </button>
    }
    <button class="btn-secondary" (click)="closeDetails()">Schließen</button>
  </ng-container>
</ui-modal>

<!-- Cancel Modal -->
<ui-modal [isOpen]="showCancelModal() && !!selectedReservation()" title="Reservierung stornieren" size="sm" (close)="closeCancelModal()">
  <ng-container modal-body>
    @if (selectedReservation()) {
      <p>Möchten Sie diese Reservierung wirklich stornieren?</p>
      <p><strong>Reservierungs-ID:</strong> {{ selectedReservation()!.reservationId.substring(0, 8) }}...</p>

      <div class="form-group">
        <label for="cancelReason">Stornierungsgrund *</label>
        <textarea
          id="cancelReason"
          [(ngModel)]="cancelReason"
          rows="4"
          placeholder="Bitte geben Sie einen Grund für die Stornierung ein..."
          class="form-control"
        ></textarea>
      </div>

      @if (error()) {
        <ui-error-state variant="inline" [message]="error()!"></ui-error-state>
      }
    }
  </ng-container>
  <ng-container modal-footer>
    <button class="btn-secondary" (click)="closeCancelModal()">Abbrechen</button>
    <button
      class="btn-danger"
      (click)="cancelReservation()"
      [disabled]="!cancelReason() || actionInProgress()"
    >
      {{ actionInProgress() ? 'Wird storniert...' : 'Stornierung bestätigen' }}
    </button>
  </ng-container>
</ui-modal>
