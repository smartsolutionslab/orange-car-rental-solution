<div class="page-header">
  <h1>Buchungsverwaltung</h1>
  <p class="subtitle">Verwalten Sie alle Reservierungen und Buchungen</p>
</div>

<!-- Statistics Dashboard -->
<div class="dashboard-grid">
  <div class="stat-card">
    <div class="stat-icon">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM5 7V5h14v2H5zm2 4h10v2H7zm0 4h7v2H7z"/>
      </svg>
    </div>
    <div class="stat-content">
      <h3>Heutige Buchungen</h3>
      <p class="stat-value">{{ todayReservations() }}</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon stat-icon--success">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
      </svg>
    </div>
    <div class="stat-content">
      <h3>Aktive Buchungen</h3>
      <p class="stat-value">{{ activeReservations() }}</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon stat-icon--warning">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
      </svg>
    </div>
    <div class="stat-content">
      <h3>Anstehend</h3>
      <p class="stat-value">{{ pendingReservations() }}</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon stat-icon--info">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
      </svg>
    </div>
    <div class="stat-content">
      <h3>Gesamt</h3>
      <p class="stat-value">{{ totalCount() }}</p>
    </div>
  </div>
</div>

<!-- Success Message -->
@if (successMessage()) {
  <div class="success-message">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    {{ successMessage() }}
  </div>
}

<!-- Error Message -->
@if (error()) {
  <div class="error-message">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
    </svg>
    {{ error() }}
  </div>
}

<div class="content-section">
  <div class="section-header">
    <h2>Reservierungsübersicht</h2>
    <button class="btn-primary" disabled>
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
      Neue Buchung
    </button>
  </div>

  <!-- Advanced Filters Section -->
  <div class="filters-panel">
    <div class="filters-header">
      <h3>Filter & Sortierung</h3>
      <div class="filters-actions">
        @if (activeFiltersCount() > 0) {
          <span class="active-filters-badge">{{ activeFiltersCount() }} aktive Filter</span>
        }
        <button class="btn-secondary btn-sm" (click)="clearFilters()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
          Zurücksetzen
        </button>
      </div>
    </div>

    <!-- Filter Grid -->
    <div class="filters-grid">
      <!-- Status Filter -->
      <div class="filter-group">
        <label for="statusFilter">Status</label>
        <select id="statusFilter" [(ngModel)]="searchStatus">
          @for (option of statusOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Customer ID Filter -->
      <div class="filter-group">
        <label for="customerFilter">Kunden-ID</label>
        <input
          type="text"
          id="customerFilter"
          [(ngModel)]="searchCustomerId"
          placeholder="Kunden-ID eingeben..."
        />
      </div>

      <!-- Pickup Date From -->
      <div class="filter-group">
        <label for="dateFromFilter">Abholung von</label>
        <input
          type="date"
          id="dateFromFilter"
          [(ngModel)]="searchPickupDateFrom"
        />
      </div>

      <!-- Pickup Date To -->
      <div class="filter-group">
        <label for="dateToFilter">Abholung bis</label>
        <input
          type="date"
          id="dateToFilter"
          [(ngModel)]="searchPickupDateTo"
        />
      </div>

      <!-- Location Filter -->
      <div class="filter-group">
        <label for="locationFilter">Standort</label>
        <input
          type="text"
          id="locationFilter"
          [(ngModel)]="searchLocation"
          placeholder="z.B. MUC, BER..."
        />
      </div>

      <!-- Min Price Filter -->
      <div class="filter-group">
        <label for="minPriceFilter">Min. Preis (€)</label>
        <input
          type="number"
          id="minPriceFilter"
          [(ngModel)]="searchMinPrice"
          placeholder="0"
          min="0"
        />
      </div>

      <!-- Max Price Filter -->
      <div class="filter-group">
        <label for="maxPriceFilter">Max. Preis (€)</label>
        <input
          type="number"
          id="maxPriceFilter"
          [(ngModel)]="searchMaxPrice"
          placeholder="1000"
          min="0"
        />
      </div>

      <!-- Apply Filters Button -->
      <div class="filter-group filter-actions">
        <button class="btn-primary btn-block" (click)="applyFilters()" [disabled]="loading()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
          </svg>
          Filter anwenden
        </button>
      </div>
    </div>

    <!-- Sorting and Grouping Controls -->
    <div class="controls-row">
      <!-- Sorting -->
      <div class="control-group">
        <label>Sortierung</label>
        <div class="sort-controls">
          <select [(ngModel)]="sortBy" (change)="applyFilters()">
            @for (option of sortOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
          <button
            class="btn-icon"
            (click)="changeSortBy(sortBy())"
            [title]="sortOrder() === 'asc' ? 'Aufsteigend' : 'Absteigend'"
          >
            @if (sortOrder() === 'asc') {
              <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M7 14l5-5 5 5z"/>
              </svg>
            } @else {
              <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            }
          </button>
        </div>
      </div>

      <!-- Grouping -->
      <div class="control-group">
        <label>Gruppierung</label>
        <select [(ngModel)]="groupBy" (change)="changeGroupBy(groupBy())">
          @for (option of groupOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Page Size -->
      <div class="control-group">
        <label>Einträge pro Seite</label>
        <select [(ngModel)]="pageSize" (change)="applyFilters()">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>

    <!-- Result Count -->
    <div class="results-info">
      <p>
        Zeige {{ (currentPage() - 1) * pageSize() + 1 }} -
        {{ Math.min(currentPage() * pageSize(), totalCount()) }}
        von {{ totalCount() }} Reservierungen
      </p>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Reservierungen werden geladen...</p>
    </div>
  }

  <!-- Reservations Table/List -->
  @if (!loading() && reservations().length > 0) {
    <!-- Grouped Display -->
    @if (groupBy() !== 'none') {
      <div class="grouped-reservations">
        @for (groupKey of groupKeys(); track groupKey) {
          <div class="group-section">
            <div class="group-header">
              <h3>{{ groupKey }}</h3>
              <span class="group-count">{{ groupedReservations()[groupKey].length }} Buchungen</span>
            </div>
            <div class="reservations-table">
              <table>
                <thead>
                  <tr>
                    <th>Reservierungs-ID</th>
                    <th>Kunde</th>
                    <th>Abholdatum</th>
                    <th>Rückgabedatum</th>
                    <th>Standort</th>
                    <th>Preis</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  @for (reservation of groupedReservations()[groupKey]; track reservation.reservationId) {
                    <tr>
                      <td>
                        <span class="reservation-id" [title]="reservation.reservationId">
                          {{ reservation.reservationId.substring(0, 8) }}...
                        </span>
                      </td>
                      <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                      <td>{{ formatDate(reservation.pickupDate) }}</td>
                      <td>{{ formatDate(reservation.returnDate) }}</td>
                      <td>{{ reservation.pickupLocationCode }}</td>
                      <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                      <td>
                        <span class="status-badge" [class]="getStatusClass(reservation.status)">
                          {{ getStatusLabel(reservation.status) }}
                        </span>
                      </td>
                      <td class="actions-cell">
                        <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">Details</button>
                        @if (canConfirm(reservation)) {
                          <button class="btn-sm btn-success" (click)="confirmReservation(reservation)">Bestätigen</button>
                        }
                        @if (canCancel(reservation)) {
                          <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">Stornieren</button>
                        }
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>
    }

    <!-- Ungrouped Display -->
    @else {
      <div class="reservations-table">
        <table>
          <thead>
            <tr>
              <th>Reservierungs-ID</th>
              <th>Kunde</th>
              <th>Abholdatum</th>
              <th>Rückgabedatum</th>
              <th>Standort</th>
              <th>Preis</th>
              <th>Status</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
            @for (reservation of reservations(); track reservation.reservationId) {
              <tr>
                <td>
                  <span class="reservation-id" [title]="reservation.reservationId">
                    {{ reservation.reservationId.substring(0, 8) }}...
                  </span>
                </td>
                <td>{{ reservation.customerId.substring(0, 8) }}...</td>
                <td>{{ formatDate(reservation.pickupDate) }}</td>
                <td>{{ formatDate(reservation.returnDate) }}</td>
                <td>{{ reservation.pickupLocationCode }}</td>
                <td class="price-cell">{{ formatPrice(reservation.totalPriceGross) }}</td>
                <td>
                  <span class="status-badge" [class]="getStatusClass(reservation.status)">
                    {{ getStatusLabel(reservation.status) }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button class="btn-sm btn-secondary" (click)="viewDetails(reservation)">Details</button>
                  @if (canConfirm(reservation)) {
                    <button class="btn-sm btn-success" (click)="confirmReservation(reservation)">Bestätigen</button>
                  }
                  @if (canCancel(reservation)) {
                    <button class="btn-sm btn-danger" (click)="showCancelDialog(reservation)">Stornieren</button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Pagination -->
    @if (totalPages() > 1) {
      <div class="pagination">
        <button
          class="btn-pagination"
          (click)="previousPage()"
          [disabled]="currentPage() === 1"
        >
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
          </svg>
          Zurück
        </button>

        <div class="page-numbers">
          @if (currentPage() > 3) {
            <button class="btn-page" (click)="goToPage(1)">1</button>
            @if (currentPage() > 4) {
              <span class="pagination-ellipsis">...</span>
            }
          }

          @for (page of [currentPage() - 2, currentPage() - 1, currentPage(), currentPage() + 1, currentPage() + 2]; track page) {
            @if (page > 0 && page <= totalPages()) {
              <button
                class="btn-page"
                [class.active]="page === currentPage()"
                (click)="goToPage(page)"
              >
                {{ page }}
              </button>
            }
          }

          @if (currentPage() < totalPages() - 2) {
            @if (currentPage() < totalPages() - 3) {
              <span class="pagination-ellipsis">...</span>
            }
            <button class="btn-page" (click)="goToPage(totalPages())">{{ totalPages() }}</button>
          }
        </div>

        <button
          class="btn-pagination"
          (click)="nextPage()"
          [disabled]="currentPage() === totalPages()"
        >
          Weiter
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
          </svg>
        </button>
      </div>
    }
  }

  <!-- Empty State -->
  @if (!loading() && reservations().length === 0) {
    <div class="empty-state">
      <svg viewBox="0 0 24 24" fill="currentColor" width="64" height="64">
        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM5 7V5h14v2H5z"/>
      </svg>
      <h3>Keine Reservierungen gefunden</h3>
      <p>Versuchen Sie, die Filter anzupassen, um weitere Ergebnisse zu sehen.</p>
    </div>
  }
</div>

<!-- Details Modal -->
@if (showDetails() && selectedReservation()) {
  <div class="modal-overlay" (click)="closeDetails()" (keydown.escape)="closeDetails()" tabindex="0" role="dialog" aria-modal="true">
    <div class="modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="document">
      <div class="modal-header">
        <h2>Reservierungsdetails</h2>
        <button class="btn-close" (click)="closeDetails()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="detail-grid">
          <div class="detail-item">
            <label>Reservierungs-ID</label>
            <p>{{ selectedReservation()!.reservationId }}</p>
          </div>
          <div class="detail-item">
            <label>Kunden-ID</label>
            <p>{{ selectedReservation()!.customerId }}</p>
          </div>
          <div class="detail-item">
            <label>Fahrzeug-ID</label>
            <p>{{ selectedReservation()!.vehicleId }}</p>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <p>
              <span class="status-badge" [class]="getStatusClass(selectedReservation()!.status)">
                {{ getStatusLabel(selectedReservation()!.status) }}
              </span>
            </p>
          </div>
          <div class="detail-item">
            <label>Abholdatum</label>
            <p>{{ formatDate(selectedReservation()!.pickupDate) }}</p>
          </div>
          <div class="detail-item">
            <label>Rückgabedatum</label>
            <p>{{ formatDate(selectedReservation()!.returnDate) }}</p>
          </div>
          <div class="detail-item">
            <label>Abholort</label>
            <p>{{ selectedReservation()!.pickupLocationCode }}</p>
          </div>
          <div class="detail-item">
            <label>Rückgabeort</label>
            <p>{{ selectedReservation()!.dropoffLocationCode }}</p>
          </div>
          <div class="detail-item">
            <label>Miettage</label>
            <p>{{ selectedReservation()!.rentalDays }}</p>
          </div>
          <div class="detail-item">
            <label>Erstellt am</label>
            <p>{{ formatDate(selectedReservation()!.createdAt) }}</p>
          </div>
        </div>

        <div class="price-section">
          <h3>Preisübersicht</h3>
          <div class="price-breakdown">
            <div class="price-row">
              <span>Nettobetrag:</span>
              <span>{{ formatPrice(selectedReservation()!.totalPriceNet) }}</span>
            </div>
            <div class="price-row">
              <span>MwSt. (19%):</span>
              <span>{{ formatPrice(selectedReservation()!.totalPriceVat) }}</span>
            </div>
            <div class="price-row total">
              <span><strong>Gesamtbetrag:</strong></span>
              <span><strong>{{ formatPrice(selectedReservation()!.totalPriceGross) }}</strong></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        @if (canConfirm(selectedReservation()!)) {
          <button class="btn-success" (click)="confirmReservation(selectedReservation()!)" [disabled]="actionInProgress()">
            Bestätigen
          </button>
        }
        @if (canCancel(selectedReservation()!)) {
          <button class="btn-danger" (click)="showCancelDialog(selectedReservation()!)" [disabled]="actionInProgress()">
            Stornieren
          </button>
        }
        <button class="btn-secondary" (click)="closeDetails()">Schließen</button>
      </div>
    </div>
  </div>
}

<!-- Cancel Modal -->
@if (showCancelModal() && selectedReservation()) {
  <div class="modal-overlay" (click)="closeCancelModal()" (keydown.escape)="closeCancelModal()" tabindex="0" role="dialog" aria-modal="true">
    <div class="modal modal-sm" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="document">
      <div class="modal-header">
        <h2>Reservierung stornieren</h2>
        <button class="btn-close" (click)="closeCancelModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Möchten Sie diese Reservierung wirklich stornieren?</p>
        <p><strong>Reservierungs-ID:</strong> {{ selectedReservation()!.reservationId.substring(0, 8) }}...</p>

        <div class="form-group">
          <label for="cancelReason">Stornierungsgrund *</label>
          <textarea
            id="cancelReason"
            [(ngModel)]="cancelReason"
            rows="4"
            placeholder="Bitte geben Sie einen Grund für die Stornierung ein..."
            class="form-control"
          ></textarea>
        </div>

        @if (error()) {
          <div class="error-message-inline">{{ error() }}</div>
        }
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeCancelModal()">Abbrechen</button>
        <button
          class="btn-danger"
          (click)="cancelReservation()"
          [disabled]="!cancelReason() || actionInProgress()"
        >
          {{ actionInProgress() ? 'Wird storniert...' : 'Stornierung bestätigen' }}
        </button>
      </div>
    </div>
  </div>
}
