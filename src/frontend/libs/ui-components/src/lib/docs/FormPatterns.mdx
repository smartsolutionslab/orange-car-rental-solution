import { Meta } from '@storybook/blocks';

<Meta title="Getting Started/Form Patterns" />

# Form Patterns

This guide covers common patterns for building forms with the Orange Car Rental component library.

## Basic Form Setup

All form components implement `ControlValueAccessor`, making them compatible with Angular's reactive forms.

```typescript
import { Component, inject, signal, computed } from '@angular/core';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import {
  InputComponent,
  TextareaComponent,
  CheckboxComponent,
  RadioGroupComponent,
  SwitchComponent,
  FileUploadComponent,
} from '@orange-car-rental/ui-components';

@Component({
  selector: 'app-contact-form',
  standalone: true,
  imports: [
    ReactiveFormsModule,
    InputComponent,
    TextareaComponent,
    CheckboxComponent,
  ],
  template: `
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <ocr-input
        label="Name"
        placeholder="Enter your name"
        formControlName="name"
        [required]="true"
        [error]="nameError()"
      />

      <ocr-input
        label="Email"
        type="email"
        placeholder="you@example.com"
        formControlName="email"
        leadingIcon="mail"
        [required]="true"
        [error]="emailError()"
      />

      <ocr-textarea
        label="Message"
        placeholder="How can we help?"
        formControlName="message"
        [rows]="4"
        [maxLength]="500"
        [showCharCount]="true"
        [required]="true"
        [error]="messageError()"
      />

      <ocr-checkbox
        label="Subscribe to newsletter"
        formControlName="newsletter"
      />

      <button type="submit" [disabled]="form.invalid">
        Send Message
      </button>
    </form>
  `
})
export class ContactFormComponent {
  private fb = inject(FormBuilder);

  form = this.fb.group({
    name: ['', Validators.required],
    email: ['', [Validators.required, Validators.email]],
    message: ['', [Validators.required, Validators.minLength(10)]],
    newsletter: [false],
  });

  // Computed error signals
  nameError = computed(() => {
    const ctrl = this.form.get('name');
    if (ctrl?.hasError('required') && ctrl?.touched) {
      return 'Name is required';
    }
    return null;
  });

  emailError = computed(() => {
    const ctrl = this.form.get('email');
    if (ctrl?.hasError('required') && ctrl?.touched) {
      return 'Email is required';
    }
    if (ctrl?.hasError('email') && ctrl?.touched) {
      return 'Please enter a valid email';
    }
    return null;
  });

  messageError = computed(() => {
    const ctrl = this.form.get('message');
    if (ctrl?.hasError('required') && ctrl?.touched) {
      return 'Message is required';
    }
    if (ctrl?.hasError('minlength') && ctrl?.touched) {
      return 'Message must be at least 10 characters';
    }
    return null;
  });

  onSubmit(): void {
    if (this.form.valid) {
      console.log(this.form.value);
    }
  }
}
```

## Validation Patterns

### Real-time Validation

Show errors as the user types (after first blur):

```typescript
// Component
readonly emailTouched = signal(false);

readonly emailError = computed(() => {
  // Re-run when touched changes
  this.emailTouched();

  const ctrl = this.form.get('email');
  if (!ctrl?.touched) return null;

  if (ctrl.hasError('required')) return 'Email is required';
  if (ctrl.hasError('email')) return 'Invalid email format';
  return null;
});

// Template
<ocr-input
  label="Email"
  formControlName="email"
  [error]="emailError()"
  (inputBlur)="emailTouched.set(true)"
/>
```

### Submit-time Validation

Only show errors on form submission:

```typescript
readonly submitted = signal(false);

readonly emailError = computed(() => {
  if (!this.submitted()) return null;

  const ctrl = this.form.get('email');
  if (ctrl?.hasError('required')) return 'Email is required';
  if (ctrl?.hasError('email')) return 'Invalid email format';
  return null;
});

onSubmit(): void {
  this.submitted.set(true);
  if (this.form.valid) {
    // Process form
  }
}
```

### Custom Validators

```typescript
import { AbstractControl, ValidationErrors } from '@angular/forms';

// Sync validator
function minAge(age: number) {
  return (control: AbstractControl): ValidationErrors | null => {
    const birthDate = new Date(control.value);
    const today = new Date();
    const years = today.getFullYear() - birthDate.getFullYear();

    return years >= age ? null : { minAge: { required: age, actual: years } };
  };
}

// Usage
form = this.fb.group({
  dateOfBirth: ['', [Validators.required, minAge(21)]],
});

readonly dobError = computed(() => {
  const ctrl = this.form.get('dateOfBirth');
  if (ctrl?.hasError('minAge') && ctrl?.touched) {
    return `You must be at least ${ctrl.errors?.['minAge'].required} years old`;
  }
  return null;
});
```

## Radio Group Pattern

```typescript
import { RadioOption } from '@orange-car-rental/ui-components';

const paymentOptions: RadioOption[] = [
  {
    value: 'card',
    label: 'Credit Card',
    description: 'Visa, Mastercard, American Express'
  },
  {
    value: 'paypal',
    label: 'PayPal',
    description: 'Pay with your PayPal account'
  },
  {
    value: 'bank',
    label: 'Bank Transfer',
    description: 'Direct bank transfer (1-3 days)',
    disabled: false
  },
];

// Template
<ocr-radio-group
  label="Payment Method"
  [options]="paymentOptions"
  formControlName="paymentMethod"
  [required]="true"
  [error]="paymentError()"
/>
```

## File Upload Pattern

```typescript
import { UploadedFile } from '@orange-car-rental/ui-components';

@Component({
  template: `
    <ocr-file-upload
      label="Documents"
      accept=".pdf,.doc,.docx"
      [maxSize]="5242880"
      [multiple]="true"
      [required]="true"
      [error]="uploadError()"
      (filesChange)="onFilesChange($event)"
      (fileRejected)="onFileRejected($event)"
    />
  `
})
export class DocumentUploadComponent {
  uploadedFiles = signal<UploadedFile[]>([]);
  uploadError = signal<string | null>(null);

  onFilesChange(files: UploadedFile[]): void {
    this.uploadedFiles.set(files);
    this.uploadError.set(null);
  }

  onFileRejected(event: { file: File; reason: string }): void {
    this.uploadError.set(`${event.file.name}: ${event.reason}`);
  }
}
```

## Multi-Step Form (Wizard) Pattern

```typescript
import { WizardStep } from '@orange-car-rental/ui-components';

@Component({
  template: `
    <ocr-wizard
      [steps]="steps"
      (stepChange)="onStepChange($event)"
      (complete)="onComplete($event)"
    >
      <ocr-wizard-step stepId="account">
        <h3>Account Information</h3>
        <ocr-input label="Email" formControlName="email" />
        <ocr-input label="Password" type="password" formControlName="password" />
      </ocr-wizard-step>

      <ocr-wizard-step stepId="personal">
        <h3>Personal Details</h3>
        <ocr-input label="First Name" formControlName="firstName" />
        <ocr-input label="Last Name" formControlName="lastName" />
      </ocr-wizard-step>

      <ocr-wizard-step stepId="confirmation">
        <h3>Review & Confirm</h3>
        <!-- Display summary -->
      </ocr-wizard-step>
    </ocr-wizard>
  `
})
export class RegistrationWizardComponent {
  steps: WizardStep[] = [
    { id: 'account', title: 'Account', subtitle: 'Login credentials' },
    { id: 'personal', title: 'Personal', subtitle: 'Your details' },
    { id: 'confirmation', title: 'Confirm', subtitle: 'Review & submit' },
  ];

  onComplete(data: any): void {
    // Submit registration
  }
}
```

## Form Layout Patterns

### Vertical Stack (Default)

```html
<form class="form-stack">
  <ocr-input label="First Name" />
  <ocr-input label="Last Name" />
  <ocr-input label="Email" type="email" />
</form>

<style>
  .form-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
```

### Two-Column Grid

```html
<form class="form-grid">
  <ocr-input label="First Name" />
  <ocr-input label="Last Name" />
  <ocr-input label="Email" type="email" class="full-width" />
</form>

<style>
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .full-width {
    grid-column: span 2;
  }

  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    .full-width {
      grid-column: span 1;
    }
  }
</style>
```

### Inline Form

```html
<form class="form-inline">
  <ocr-input placeholder="Search..." leadingIcon="search" size="sm" />
  <button type="submit">Search</button>
</form>

<style>
  .form-inline {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
  }
</style>
```

## Loading & Submission States

```typescript
@Component({
  template: `
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <ocr-input
        label="Email"
        formControlName="email"
        [disabled]="isSubmitting()"
      />

      <button
        type="submit"
        [disabled]="form.invalid || isSubmitting()"
      >
        @if (isSubmitting()) {
          <span class="spinner"></span>
          Submitting...
        } @else {
          Submit
        }
      </button>
    </form>
  `
})
export class SubmitFormComponent {
  isSubmitting = signal(false);

  async onSubmit(): Promise<void> {
    if (this.form.invalid) return;

    this.isSubmitting.set(true);
    try {
      await this.apiService.submit(this.form.value);
      // Handle success
    } catch (error) {
      // Handle error
    } finally {
      this.isSubmitting.set(false);
    }
  }
}
```

## Best Practices

### 1. Use Signals for Reactive State

```typescript
// Good - reactive computed error
readonly nameError = computed(() => {
  const ctrl = this.form.get('name');
  if (ctrl?.hasError('required') && ctrl?.touched) {
    return 'Name is required';
  }
  return null;
});

// Avoid - function call in template
getNameError(): string | null {
  // Called on every change detection
}
```

### 2. Provide Clear Error Messages

```typescript
// Good - specific, actionable
'Password must be at least 8 characters with one uppercase letter'

// Avoid - vague
'Invalid password'
```

### 3. Mark Required Fields

```html
<ocr-input
  label="Email"
  [required]="true"  <!-- Shows asterisk -->
/>
```

### 4. Use Appropriate Input Types

```html
<ocr-input type="email" autocomplete="email" />
<ocr-input type="tel" autocomplete="tel" />
<ocr-input type="password" autocomplete="new-password" />
```

### 5. Group Related Fields

```html
<fieldset>
  <legend>Billing Address</legend>
  <ocr-input label="Street" />
  <ocr-input label="City" />
  <ocr-input label="Postal Code" />
</fieldset>
```
